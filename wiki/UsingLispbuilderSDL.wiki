#summary LISPBUILDER-SDL User Guide
#sidebar TableOfContentsSDL

<wiki:toc max_depth="3" />

= About LISPBUILDER-SDL =

LISPBUILDER-SDL provides abstractions to graphics, sound, physics (TBD), character animation (TBD) and 3D libraries (in development) allowing the development of interactive applications and games in Common Lisp.

Core functionality includes window and event loop management, support for 2D bitmap and vector graphics, 2D graphical effects such as rotation, color keying and alpha blending, many graphics drawing primitives such as circles, polygons, squares, Bezier and Cuttmull-Rom curves, vector drawing, image loading (bmp, jpeg, png, tiff, tga), sound mixing and playback of samples (WAV) and streaming music (mp3 and ogg formats), bitmap and true-type font support. 

Optional packages allow the core functionality described above to be enhanced to provide additional capabilities such 3D scene management, physics and character animation.

= Introduction =

LISPBUILDER-SDL is not distributed with any Common Lisp development environment and must be downloaded and installed separately. Installation is always tricky for the Lisp newbie because Lisp packages are unlike similar packages for other languages, but we have attempted to provide [http://code.google.com/p/lispbuilder/wiki/DownloadInstallationIntro comprehensive instructions] for all supported platforms. Support is also provided on the [http://code.google.com/p/lispbuilder/wiki/Community Lispbuilder Mailing List]. Before downloading, verify that your Lisp implementation and operating system [http://code.google.com/p/lispbuilder/wiki/DownloadInstallationIntro are supported].

Once installed, LISPBUILDER-SDL must be loaded into your Common Lisp environment by following the instructions [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Loading_LISPBUILDER-SDL here].

The structure of a simple game follows the pattern;

  # [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Initializing_LISPBUILDER-SDL Initialize the library]
  # [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#The_Display Create a display]
  # [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#The_Game_Loop Start the game loop] to [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Introduction_to_Input_Handling handle input events], [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Executing_Game_Logic perform the game logic], and [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Updating_the_Display update the display]
  # Goto to 3

The following example makes a box (a filled rectangle) follow the position of the mouse cursor, redrawing the box in a new color when the mouse button is depressed. Pressing any key will exit the example.

http://lispbuilder.googlecode.com/svn/trunk/documentation/mouse-rect-2d.jpg

{{{
(defparameter *random-color* sdl:*white*)
(defun mouse-rect-2d ()
  (sdl:with-init ()
    (sdl:window 200 200 :title-caption "Move a rectangle using the mouse")
    (setf (sdl:frame-rate) 60)

    (sdl:with-events ()
      (:quit-event () t)
      (:key-down-event ()
       (sdl:push-quit-event))
      (:idle ()
       ;; Change the color of the box if the left mouse button is depressed
       (when (sdl:mouse-left-p)
         (setf *random-color* (sdl:color :r (random 255) :g (random 255) :b (random 255))))

       ;; Clear the display each game loop
       (sdl:clear-display sdl:*black*)

       ;; Draw the box having a center at the mouse x/y coordinates.
       (sdl:draw-box (sdl:rectangle-from-midpoint-* (sdl:mouse-x) (sdl:mouse-y) 20 20)
                     :color *random-color*)

       ;; Redraw the display
       (sdl:update-display)))))
}}}

First create a variable to hold the color.

{{{
(defparameter *random-color* sdl:*white*)
}}}

LISPBUILDER-SDL must be [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Initializing_LISPBUILDER-SDL initialized prior to use]. The example only draws to the screen and so there is no need to initialize the audio, joystick, or CDROM subsystems.

{{{
(sdl:with-init ()
}}}

Next, create a 200 pixel by 200 pixel [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#The_Display graphics window]. Some kind of display (window or full-screen) must be created to receive events from the Window Manager.

{{{
    (sdl:window 200 200 :title-caption "Move a rectangle using the mouse")
}}}

Lock the [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Setting_the_Frame_Rate frame-rate] to 60 fps.

{{{
    (setf (sdl:frame-rate) 60)
}}}

Create the [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#The_Game_Loop game loop] to process the incoming user events.

{{{
    (sdl:with-events ()
}}}

The event loop will exit only when the [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Quit_Event :QUIT-EVENT] handler returns `T`. Always remember to handle this event or the event loop will never exit. This handler is called when a quit event is received in the event queue. A quit event is generated when the user attempts to close the window, or any time [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#push-quit-event SDL:PUSH-QUIT-EVENT] is called.

{{{
      (:quit-event () t)
}}}

The [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Keyboard_Events :KEY-DOWN-EVENT] handler is called for each key depressed. We want to exit the example to exit when a key is pressed, therefore push the quit event onto the event queue [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#push-quit-event SDL:PUSH-QUIT-EVENT] causing `:QUIT-EVENT` to fire on the next event loop.

{{{
      (:key-down-event ()
       (sdl:push-quit-event))
}}}

Most game logic will be called from the [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#IDLE_Event :IDLE event]. This handler is called when all other events in the event queue have been processed for the current event loop. In other words, `:IDLE` is called when the game loop is 'idle' and as such :IDLE is not a real system event.

{{{
      (:idle ()
}}}

Generate a random color while the right mouse button is depressed. Keeping the mouse down will cause the colors to cycle. [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#mouse-left-p MOUSE-LEFT-P] returns `T` when the right mouse button is depressed.

{{{
       (when (sdl:mouse-left-p)
         (setf *random-color* (sdl:color :r (random 255) :g (random 255) :b (random 255))))
}}}

Clear the screen prior to drawing the rectangle. 

{{{
       (sdl:clear-display sdl:*black*)
}}}

Draw the box. A new rectangle is created having a midpoint at the current cursor position using [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#rectangle-from-midpoint-* RECTANGLE-FROM-MIDPOINT-*]. [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#mouse-x MOUSE-X] and [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#mouse-y MOUSE-Y] return the current mouse cursor position.

{{{
       (sdl:draw-box (sdl:rectangle-from-midpoint-* (sdl:mouse-x) (sdl:mouse-y) 20 20)
                     :color *random-color*)
}}}

The display is then redrawn at the end of the game loop.

{{{
       (sdl:update-display)))))
}}}

= Compatibility & Platforms Supported =

LISPBUILDER-SDL runs on all of the popular Common Lisp implementations. The [http://code.google.com/p/lispbuilder/wiki/DownloadInstallationIntro compatibility table] lists the combinations of implementation and operating system that are supported.

= Loading LISPBUILDER-SDL =

After [http://code.google.com/p/lispbuilder/wiki/DownloadInstallation#Download_&_Installation_of_LISPBUILDER-SDL installation] is complete, `LISPBUILDER-SDL` can be loaded as follows;

{{{
(ASDF:OPERATE 'ASDF:LOAD-OP :LISPBUILDER-SDL)
}}}

Or if you are using SLIME, enter `,` then `l` then `LISPBUILDER-SDL`

= Initializing LISPBUILDER-SDL =

`LISPBUILDER-SDL` *must* be initialized prior to use. Audio, video, joystick and CDROM are separate subsystems and must also be initialized prior to use. The following functions will initialize (and close) the `LISPBUILDER` library;

  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-init WITH-INIT], initialize/close the library and specified subsystems.
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#init-sdl INIT-SDL], initialize the library and specified subsystems.
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#quit-sdl QUIT-SDL], close the library and specified subsystems.

The video, audio, joystick and CDROM subsystems are automatically initialized as follows;

  * `WINDOW` will initialize the video subsystem when creating the display,
  * `OPEN-AUDIO` will initialize the audio subsystem when opening audio,
  * `OPEN-JOYSTICK` will initialize the joystick subsystem when opening the joystick for use _(not yet supported)_,
  * `OPEN-CDROM` will initialize the CDROM subsystem when opening the CDROM drive for use _(not yet supported)_

Individual subsystems can also be initialized using `INIT-SDL` and `WITH-INIT`.

{{{
(SDL:INIT-SDL :VIDEO T :AUDIO T)
}}}

or, [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-init WITH-INIT], by passing the subsystems as parameters, for example

{{{
(SDL:WITH-INIT (SDL:SDL-INIT-VIDEO SDL:SDL-INIT-AUDIO)
  ...)
}}}

The list of subsystems is as follows;

  * `SDL-INIT-VIDEO`, The video subsystem
  * `SDL-INIT-AUDIO`, The audio subsystem
  * `SDL-INIT-CDROM`, The cdrom subsystem
  * `SDL-INIT-JOYSTICK`, The joystick subsystem
  * `SDL-INIT-NOPARACHUTE`, Prevents `SDL` from catching fatal signals.

`INIT-SDL` will only initialize subsystems that are not already initialized. To force the initialization of subsystems regardless of current status use `:FORCE T`, for example

{{{
(SDL:INIT-SDL :VIDEO T :AUDIO T :FORCE T)
}}}

Video, audio, joystick and CDROM subsystems can be initialized at any time using the following functions;

  * `INIT-SDL`, initializes a list of subsystems not already initialized,
  * `INIT-VIDEO`, initializes the video subsystem if not already initialized,
  * `INIT-AUDIO`, initializes the video subsystem if not already initialized,
  * `INIT-CDROM`, initializes the CDROM subsystem if not already initialized,
  * `INIT-JOYSTICK`, initializes the joystick subsystem if not already initialized,

These functions will force the initialization of the specified subsystem regardless of current status when `FORCE` is `T`.

The status of the library or of any subsystem can be queried at runtime using;
  
  * `SDL-INIT-P`, returns a list of initialized subsystems,
  * `VIDEO-INIT-P`, returns `T` if the video subsystem is initialized,
  * `AUDIO-INIT-P`, returns `T` if the audio subsystem is initialized,
  * `CDROM-INIT-P`, returns `T` if the CDROM subsystem is initialized,
  * `JOYSTICK-INIT-P`, returns `T` if the joystick subsystem is initialized,

{{{
>> (SDL:SDL-INIT-P SDL:SDL-INIT-VIDEO)
((LISPBUILDER-SDL-CFFI::SDL-INIT-VIDEO 32))

>> (SDL:VIDEO-INIT-P)
T
}}}

Subsystems can be closed at any time using the following functions;
  
  * `QUIT-SDL`, closes the list of initialized subsystems or all initialized subsystems if unspecified,
  * `QUIT-VIDEO`, closes the video subsystem if initialized,
  * `QUIT-AUDIO`, closes the audio subsystem if initialized,
  * `QUIT-CDROM`, closes the CDROM subsystem if initialized,
  * `QUIT-JOYSTICK`, closes the joystick subsystem if initialized

These functions will force close of the specified subsystems regardless of current status when `FORCE` it `T`.

Using [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-init WITH-INIT] will automatically close lispbuilder-sdl upon exit.

= Hardware =
== Graphics Hardware Capabilities ==

`LISPBUILDER-SDL` can utilize the following capabilities of the graphics hardware if available;

  * Create surfaces in video memory,
  * Use a window manager if available,
  * Hardware acceleration for video memory to video memory blits,
    * For normal surfaces, 
    * Or when color keying, or 
    * When using alpha transparency,
  * Hardware acceleration for system memory to video memory blits,
    * For normal surfaces, 
    * Or when color keying, or 
    * When using alpha transparency,
  * Hardware acceleration for color fills,
  * OpenGL for 2D or 3D acceleration.

The capabilities of the video hardware can be queried following initialization of the video subsystem `(INIT-SDL :VIDEO T`), or `(INIT-VIDEO)`. Prior to the display being created (using `WINDOW`) these functions will return the best video mode available. After the display is created these functions will return the current video mode.

  * `HW-AVAILABLE-P`, is it possible to create hardware surfaces, or is the current video display in video memory?
  * `WM-AVAILABLE-P`, is there a window manager available?
  * `BLIT-HW-P`, are video memory to video memory blits accelerated?
  * `BLIT-HW-CC-P`, are video memory to video memory color key blits accelerated?
  * `BLIT-HW-A-P`, are video memory to video memory alpha blits accelerated?
  * `BLIT-SW-P`, are system memory to video memory blits accelerated?
  * `BLIT-SW-CC-P`, are system memory to video memory color key blits accelerated?
  * `BLIT-SW-A-P`, are system memory to video memory alpha blits accelerated?
  * `BLIT-FILL-P`, are color fills accelerated? 
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#video-info VIDEO-INFO] queries the capabilities of the graphics hardware,
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#video-memory VIDEO-MEMORY] returns the amount of video memory available,
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#video-dimensions VIDEO-DIMENSIONS] returns the best video width and height supported by the graphics hardware, and
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#list-modes LIST-MODES] returns a list of of window dimensions supported by the graphics hardware.
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#video-river-name VIDEO-DRIVER-NAME] returns the name of the video driver.

The video driver exposes hardware capabilities to the library. The `windib` display driver is used in Windows by default. This driver provides almost no support for the underlying hardware and will perform all graphical operations in software. However `windib` is the most compatible across hardware and operating system versions, and is usually the best choice in terms of speed especially when using color keys or alpha blending.

The video driver can be specified by passing the driver name to `WINDOW` using `:VIDEO-DRIVER`, or using `SET-VIDEO-DRIVER`. The display driver is set prior to creating the display.

  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Video_Driver SET-VIDEO-DRIVER] sets the video driver.

The audio driver can be specified by passing the driver name to `WINDOW` using `:AUDIO-DRIVER`, or using `SET-AUDIO-DRIVER`. The display driver is set prior to creating the display.

  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Audio_Driver SET-AUDIO-DRIVER] sets the audio driver.

== Video Info ==

Use [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#video-info VIDEO-INFO] to query the capabilities of the graphics hardware.

{{{
video-info &optional info => result
}}}

`:INFO` can be one of:

  * `:NIL`, returns a list of all supported video hardware capabilities
  * `:HW-AVAILABLE`, Is it possible to create hardware surfaces?
  * `:WM-AVAILABLE`, Is there a window manager available?
  * `:BLIT-HW`, Are hardware to hardware blits accelerated?
  * `:BLIT-HW-CC`, Are hardware to hardware colorkey blits accelerated?
  * `:BLIT-HW-A`, Are hardware to hardware alpha blits accelerated?
  * `:BLIT-SW`, Are software to hardware blits accelerated?
  * `:BLIT-SW-CC`, Are software to hardware colorkey blits accelerated?
  * `:BLIT-SW-A`, Are software to hardware alpha blits accelerated?
  * `:BLIT-FILL`, Are color fills accelerated?

For example, enter the following to determine the capabilities of the video hardware;

{{{
>> (SDL:SET-VIDEO-DRIVER "windib")
0

>> (SDL:INIT-VIDEO)
T

>> (SDL:VIDEO-INFO))
(:WM-AVAILABLE)

>> (SDL:QUIT-SDL)

>> (SDL:SET-VIDEO-DRIVER "directx")
0

>> (SDL:INIT-VIDEO)
T

>> (SDL:VIDEO-INFO))
(:HW-AVAILABLE :WM-AVAILABLE :BLIT-SW-CC :BLIT-FILL :BLIT-HW-CC :BLIT-SW :BLIT-HW)

}}}

== Video Memory ==

Use [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#video-memory VIDEO-MEMORY] to query the amount of video memory available. Only makes sense when surfaces can be created in video memory, `(HW-AVAILABLE-P)` returns `T`, otherwise `0` video memory is reported.

For example;

{{{
>> (SDL:INIT-VIDEO)
T

>> (SDL:HW-AVAILABLE-P)
NIL

>> (SDL:VIDEO-MEMORY)
0
}}}

== Video Dimensions ==

[http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#video-dimensions VIDEO-DIMENSIONS] returns the best video width and height if called before a window is created. Or returns the current video dimensions if called after a window is created. 

For example;

{{{
>> (SDL:INIT-VIDEO)
T

>> (SDL:VIDEO-DIMENSIONS)
#(1280 800)
}}}

== List Modes ==

[http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#list-modes LIST-MODES] returns a list sorted largest to smallest of the width and height of the screens that will support the type of video surface requested in `:FLAGS`. 

{{{
list-modes flags &optional surface => result
}}}

`FLAGS` can be one or more of the following;

  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#sdl-sw-surface SDL-SW-SURFACE] a video surface in system memory,
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#sdl-hw-surface SDL-HW-SURFACE] a video surface in video memory, 
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#sdl-async-blit SDL-ASYNC-BLIT] asynchronously updates supported, 
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#sdl-any-format SDL-ANY-FORMAT], see the Section Color Depth.
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#sdl-hw-palette SDL-HW-PALETTE] exclusive palette access.
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#sdl-doublebuf SDL-DOUBLEBUF] hardware double buffering.
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#sdl-fullscreen SDL-FULLSCREEN] full-screen mode.
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#sdl-opengl SDL-OPENGL] an OpenGL rendering context.
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#sdl-resizable SDL-RESIZABLE] a resizable window, and 
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#sdl-no-frame SDL-NO-FRAME] no title bar or frame decoration.

For example;

{{{
>> (SDL:INIT-VIDEO)
T

>> (SDL:LIST-MODES '(SDL:SDL-HW-SURFACE SDL:SDL-FULLSCREEN SDL:SDL-DOUBLEBUF))
(#(1280 800) #(1024 768) #(800 1280) #(800 600) #(768 1024) 
 #(640 480) #(640 400) #(600 800) #(512 384) #(480 640) #(400 640) 
 #(384 512) #(320 200))
}}}

== Video Driver ==

`SET-VIDEO-DRIVER` will attempt to use the specified video driver to create the display. The video drivers supported are listed in the [http://www.libsdl.org/cgi/docwiki.cgi/SDL_envvars SDL documentation]. Set the video driver after the video subsystem has been initialized, but before the display is created. 

Valid drivers for Windows are "windib" and "directx". The default video driver is "windib".

For example;

{{{
>> (SDL:SET-VIDEO-DRIVER "windib")
}}}

`:VIDEO-DRIVER` when passed to `WINDOW` will also set the video driver.

== Audio Driver ==

`SET-AUDIO-DRIVER` will attempt to use the specified audio driver. The audio drivers supported are listed in the [http://www.libsdl.org/cgi/docwiki.cgi/SDL_envvars SDL documentation]. Set the audio driver after the audio subsystem has been initialized, but before the display is created.

Valid drivers for Windows are "pulse", "dsound" and "waveout".

For example;

{{{
>> (SDL:SET-AUDIO-DRIVER "waveout")
}}}

`:AUDIO-DRIVER` when passed to `WINDOW` will also set the audio driver.

== Video Driver Name ==

`VIDEO-DRIVER-NAME` will return the name if the video driver. The video drivers supported are listed in the [http://www.libsdl.org/cgi/docwiki.cgi/SDL_envvars SDL documentation]. This function is useful only after the video subsystem has been initialized. 

For example;

{{{
>> (SDL:INIT-VIDEO)
T

>> (SDL:VIDEO-DRIVER-NAME)
"windib"
}}}


= The Display =
== Description of the Display ==

Graphics are rendered to a video surface. A [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#surface SURFACE] represents an area of _graphical_ memory that can be drawn or rendered to, for example the video frame buffer or an image that is loaded from disk. 

The video surface must be updated at least once each game loop using the function [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#update-display UPDATE-DISPLAY]. The display can be filled with a background color using [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#clear-display CLEAR-DISPLAY].

The properties of an the vidoe surface can be queried using [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#video-info VIDEO-INFO]. The screen resolutions supported by a particular set of video flags can be retrieved using [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#list-modes LIST-MODES]. The name of the video driver can be retrieved as a STRING using [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#video-driver-name VIDEO-DRIVER-NAME].

Use [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#window WINDOW] to create and configure the video surface on startup. 

{{{
window width height 
       &key flags sw hw fullscreen async-blit any-format palette double-buffer opengl resizable no-frame 
       bpp title-caption icon-caption position fps 
       video-driver audio-driver => result
}}}

Use [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#resize-window RESIZE-WINDOW] to modify the video surface during program execution.

{{{
resize-window width height &key bpp flags sw hw fullscreen async-blit any-format palette double-buffer opengl resizable no-frame title-caption icon-caption => result
}}}

For example;

{{{
(SDL:WINDOW 320 240 :TITLE-CAPTION "Random Rectangles" :ICON-CAPTION "Random Rectangles"  
                    :DOUBLE-BUFFER T :FULLSCREEN T :POSITION t)
}}}

*Parameters*

  * `WIDTH` and `HEIGHT` are the pixel width and height of the video surface. If WIDTH and HEIGHT are both 0, then the width and height of the current video mode is used (or the desktop mode, if no mode has been set). 
  * `:BPP` is the the number of bits per pixel. See the section [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Color_depth Color depth] for more information.
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Window_Title_and_Border :TITLE-CAPTION] appears in the Window title bar. 
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Window_Title_and_Border :ICON-CAPTION] appears when the Window is minimized.
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Window_x_and_y_position :POSITION] sets the Window X and Y position.
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Frame_Rate :FPS] specify game loop to be constant frame rate, or constant time-step.
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Video_Driver :VIDEO-DRIVER] select the video driver to use,
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Audio_Driver :AUDIO-DRIVER] select the audio driver to use,
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Full-screen_or_Windowed :FULLSCREEN], use full-screen mode,
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Display_Surface_in_System_Memory_or_Video_Memory :SW], and [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Display_Surface_in_System_Memory_or_Video_Memory :HW], create the surface in System or Video Memory,
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Synchronous_or_Asynchronous_updates :ASYNC-BLIT] update the video surface asynchronously to the main thread, 
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Color_depth :ANY-FORMAT] see the Section Color Depth,
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Exclusive_palette_access :PALETTE] sets exclusive palette access. Without this flag you may not always get the the colors you request using `SDL_SetColors` or `SDL_SetPalette`,
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Single_or_Double_buffering :DOUBLE-BUFFER] will enable hardware double buffering,
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#OpenGL_rendering :OPENGL] will create an OpenGL rendering context,
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Window_Title_and_Border :RESIZABLE] will create a resizable window, and [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Window_Title_and_Border :NO-FRAME] creates a window with no title bar or frame decoration.

== Dimensions ==

The window width and height are retrieved using [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#video-dimensions VIDEO-DIMENSIONS].

{{{
>> (SDL:WINDOW 320 240)

>> (SDL:VIDEO-DIMENSIONS)
#(320 240)
}}}


== Full-screen or Windowed ==

`LISPBUILDER-SDL` will create a windowed display by default. However this can be changed on startup or any time during program execution by setting `:FULLSCREEN`. 

{{{
>> (SDL:WINDOW 320 240 :FULLSCREEN T)
}}}

If the specified resolution is not supported in full-screen mode then the next higher resolution will be used and the display window will be centered on a black background.

== Color depth ==

When `:BPP` is unspecified or `0`, the surface will be created with the bits-per-pixel of the current display.

Normally if a video surface of the requested bits-per-pixel is not available one is emulated using a shadow surface. Setting `:ANY-FORMAT` prevents this. If `:ANY-FORMAT` is used and the requested pixel depth (`:BPP`) is unavailable, a display surface having a bits-per-pixel that matches the current display is returned. For example;

{{{
(SDL:WINDOW 320 240 :BPP 32 :ANY-FORMAT T)
}}}

The valid values for `:BPP` are as follows;

  * `0`, or `NIL` create the surface using the bits-per-pixel of the current display,
  * `8`, use a 256 index color palette (not supported in lispbuilder-sdl right now),
  * `16`, allows 65,536 colors,
  * `24`, allows 16,777,216 colors,
  * `32`, use the common 8 bits per pixel allowing 4.2 billion colors.

A bits-per-pixel of 24 uses the packed representation of 3 bytes per pixel. For the more common 4 bytes per pixel mode, please use a bits-per-pixel of 32.

== Window Title and Border ==

Use `:TITLE-CAPTION` to set the caption in the window title bar. Use `:ICON-CAPTION` to set the caption when the window is minimized. For example;

{{{
(SDL:WINDOW 320 240 :TITLE-CAPTION "A Test"
                    :ICON-CAPTION "A Test Minimized"))
}}}

To allow the window to be resized, set `:RESIZABLE`.  The library will allow the window manager, if any, to resize the window at runtime.  When this occurs, a `VIDEO-RESIZE-EVENT` event is sent to the application, and the application must respond by calling `RESIZE-WINDOW` with the requested size (or another size that suits the application).

{{{
(SDL:WINDOW 320 240 :TITLE-CAPTION "A Test"
                    :ICON-CAPTION "A Test Minimized")
                    :RESIZABLE T)
}}}

To remove the title bar and border decoration from the window, set `:NO-FRAME`. Full-screen modes automatically have this flag set.

{{{
(SDL:WINDOW 320 240 :TITLE-CAPTION "A Test"
                    :ICON-CAPTION "A Test Minimized")
                    :NO-FRAME T)
}}}

== Window X and Y Position ==

Use `:POSITION` to set the display window x and y position as follows;

  * When `NIL` will use the previous x and y positions,
  * When `T` will center the window on the screen,
  * When `(VECTOR x y)` will set the window to the specified x and y positions.

For example;

{{{
(SDL:WINDOW 320 240 :POSITION #(100 200))
}}}

== Display Surface in System Memory or Video Memory ==

The display surface can be created in system memory (`:SW`) or video memory (`:HW`). When the display is created in system memory a software surface is returned. When the display is created in video memory a hardware surface is returned.

A surface in system memory (software surface) improves the performance of pixel level access but is incompatible with some types of hardware blitting.

A surface in video memory (hardware surface) takes advantage of Video-to-Video blits which are often hardware accelerated.

Generally, create your display surface in system memory unless you know what you are doing. This topic is discussed in greater detail in [TBD]

The system may return a software surface even when a hardware surface is requested as many platforms can only provide a hardware surface when using `SDL-FULL-SCREEN`. 

For example;

{{{
(SDL:WINDOW 320 240 :SW T)
}}}

== Synchronous or Asynchronous updates ==

`:ASYNC-BLIT` enables the use of asynchronous updates of the display surface. This will usually slow down blitting on single CPU machines, but may provide a speed increase on SMP systems.

An overview is provided on the SDL developers mailing list [http://lists.libsdl.org/pipermail/sdl-libsdl.org/2005-February/048955.html here], and [http://lists.libsdl.org/pipermail/sdl-libsdl.org/2006-January/053805.html here]

This has not been well tested on the supported Lisp platforms so use at your own risk. It may be problematic on Lisps that do not support multi-threading.

For example;

{{{
(SDL:WINDOW 320 240 :ASYNC-BLIT T)
}}}


== Exclusive palette access ==

`:PALETTE` will guarantee that the colors set by SDL_SetColors() will be the colors you get. Otherwise, in 8-bit mode, SDL_SetColors() may not be able to set all of the colors exactly the way they are requested, and you should look at the video surface structure to determine the actual palette.
If SDL cannot guarantee that the colors you request can be set, i.e. if the colormap is shared, then the video surface may be created under emulation in system memory, overriding `:HW`.

For example;

{{{
(SDL:WINDOW 320 240 :PALETTE T)
}}}

== Single or Double buffering ==

`:DOUBLE-BUFFER` will try to set up two surfaces in video memory and swap between them when you call `UPDATE-DISPLAY`.  This is usually slower than the normal single-buffering scheme, but prevents "tearing" artifacts caused by modifying video memory while the monitor is refreshing.  Double buffering should only be used by applications that redraw the entire screen on every update.

For example;

{{{
(SDL:WINDOW 320 240 :DOUBLE-BUFFER T)
}}}

== OpenGL rendering ==

`:OPENGL` will create an OpenGL rendering context.

For example;

{{{
(SDL:WINDOW 320 240 :OPENGL T)
}}}

== Redraw the Display ==

Use [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#update-display UPDATE-DISPLAY] to;

  * Update the video surface, or
  * Swap video buffers if double buffering is enabled, or 
  * Swap OpenGL buffers if there is a valid OpenGL context, `:OPENGL` is set.

The display should be redrawn once per game loop.

== Clearing the Display ==

Use [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#clear-display CLEAR-DISPLAY] to clear video display using a specific color.

== Determining the Properties of the Current Video Display Surface ==

The following functions return the properties of the current display surface;

  * `OPENGL-CONTEXT-P` returns `T` if there is a valid OpenGL context,
  * `DOUBLE-BUFFERED-P` returns `T` if the display is double-buffered
  * `FULLSCEEN-P` returns `T` if the display is fullscreen, or `NIL` if windowed,
  * `RESIZABLE-P` returns `T` if the display is resizable, or `NIL` if fullscreen or not resizable.
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#video-info SURFACE-INFO] retrieves the properties of the current display surface.

== Native Window ==

A foreign pointer pointer to the display surface can be retrieved using [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#get-native-window GET-NATIVE-WINDOW]. 

= Application State =

Application state includes mouse focus, keyboard focus and window show state. The following functions will return the current application state;

  * `MOUSE-FOCUS-P`, the application has mouse focus. The mouse is currently within the window area.
  * `INPUT-FOCUS-P`, the application has keyboard focus. All key events will be received by the application.
  * `ACTIVE-P`, the application window show state which can be minimized/iconified, or restored.

For example;

{{{
>> (SDL:ACTIVE-P)
T
}}}
embarrassing embarrasing 
= Key processing =

`LISPBUILDER-SDL` provides control over Unicode processing and key repeat intervals.

== Unicode ==

To obtain the character codes corresponding to received keyboard events, Unicode translation must first be turned on using `ENABLE-UNICODE`. The translation incurs a slight overhead for each keyboard event and is therefore disabled by default. For each subsequently received `:KEY-DOWN-EVENT`, the `:UNICODE` keyword will contain the corresponding character code, or zero for keys that do not correspond to any character code. _Note_ that only key press events will be translated, not release events.

  * `UNICODE-ENABLED-P`, queries the current state of Unicode keyboard translation. Returns `T` if enabled, and `NIL` if disabled.
  * `ENABLE-UNICODE`, enables Unicode translation.
  * `DISABLE-UNICODE`, disables Unicode translation.

== Key Repeat ==

A single `:KEY-DOWN-EVENT` is generated per key press regardless of how long the key is depressed. When key repeat is enabled, multiple `:KEY-DOWN-EVENT`s are generated per the specified delay and interval.

{{{
ENABLE-KEY_REPEAT delay interval
}}}

`DELAY` is the amount of time that elapses before characters repeat when a key is depressed. `INTERVAL` determines how fast characters repeat when a key is depressed. Both `DELAY` and `INTERVAL` are expressed in milliseconds. Setting `DELAY` or `INTERVAL` to `NIL` will set the default values of the constants `SDL-DEFAULT-REPEAT-DELAY` and `SDL-DEFAULT-REPEAT-INTERVAL` respectively. _Note_: `ENABLE-KEY-REPEAT` must be called after the SDL library has been initialized to have any effect.

The functions for controlling key repeat are;

  * `ENABLE-KEY-REPEAT`, enables the keyboard repeat. 
  * `DISABLE-KEY-REPEAT`, disables the keyboard repeat.
  * `KEY-REPEAT-ENABLED-P`, returns the current keyboard delay and keyboard repeat rate interval in milliseconds as `(VALUES DELAY INTERVAL)`."
  * `KEY-REPEAT-ENABLED`, returns the current key repeat delay, in milliseconds.
  * `KEY-REPEAT-INTERVAL`, returns the current key repeat interval, in milliseconds.

= The Game Loop =
== Description of the Game Loop ==

Unlike desktop application software that is usually event driven, a game is typically built around a game loop. The game loop is responsible for [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Introduction_to_Input_Handling processing user input], [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Executing_Game_Logic executing game logic], [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Setting_the_Frame_Rate_and_Timestep limiting the frame rate], and [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Updating_the_Display redrawing the display].

The [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-events WITH-EVENTS] macro forms the core of the game loop and is discussed in the following sections.

== Introduction to Input Handling ==
=== Description of Input Events ===

Interaction with the user is a significant part of a game. The game loop receives input from the user, executes the game logic based on this input, and generates output - usually in the form of graphics rendered to a display. For each input stimuli the system will generate a corresponding event. Inputs are received from the mouse, keyboard, joystick, window manager, and user (user generated). The system creates events to match these inputs; for example a key when depressed will generate a key down event. Releasing the key will generate a key up event. The [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-events WITH-EVENTS] macro provides an efficient mechanism for processing these events.

For example, while the mouse is moved a constant stream of `:MOUSE-MOTION-EVENT` events are generated. To process the x and y mouse position the user must provide a `:MOUSE-MOTION-EVENT` handler. `WITH-EVENTS` calls the handler each time this event is received. Event handlers are straight forward to define as shown in the code below;

{{{
(WITH-EVENTS ()
  (:MOUSE-MOTION-EVENT (:X mouse-x :Y mouse-y)
    ...))
}}}

The only event that *must* be handled is `:QUIT-EVENT`. If `:QUIT-EVENT` is ignored then it becomes impossible to close the Window or exit the game loop.

{{{
(WITH-EVENTS ()
  (:QUIT-EVENT () T)
  (:MOUSE-MOTION-EVENT (:X mouse-x :Y mouse-y)
    ...))
}}}

Event processing is described in greater detail in section [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Event_Processing Event Processing].

=== Description of Input State ===

In addition to event processing, the system also provides functions to query the current state of the keyboard, mouse, display and joystick. 

Unlike events that are generated in response to input; state is the way something is with respect to its main attributes. For example a `:KEY-DOWN-EVENT` event may signal that a the `:SDL-KEY-ESCAPE` key is depressed. However the current state of the keyboard may indicate that keys `:SDL-KEY-ESCAPE` and `:SDL-KEY-SPACE` are currently depressed.

Input State is described in greater detail in section [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Input_State Input State].


== Executing Game Logic ==

`:IDLE`, although not technically an actual event, is executed once per game loop after all events have been processed. Place logic to be executed in the game loop that is not event driven in `:IDLE`. This logic may update world physics, update the state of game objects and render sprites to the display.

{{{
(SDL:WITH-EVENTS ()
  (:QUIT-EVENT () T)
  (:MOUSE-MOTION-EVENT (:X mouse-x :Y mouse-y)
    ...)
  (:IDLE () 
    (SDL:UPDATE-DISPLAY)))
}}}

== Setting the Frame Rate ==

[http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-events WITH-EVENTS] can limit the game loop to a number of iterations a second, or maintain a constant time-step described in [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Frame_Rate_and_Timestep Frame Rate].

== Updating the Display ==

Use [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#update-display UPDATE-DISPLAY] to refresh the video surface or swap buffers if double buffering is enabled. The display should be redrawn once per game loop.

= Event Processing =
== Poll or Wait ==

[http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-events WITH-EVENTS] can either POLL or WAIT for events on the queue by specifying `:POLL` or `:WAIT` respectively, for example;

{{{
(SDL:WITH-EVENTS (:POLL)  
  (:QUIT-EVENT () T)  
  (:KEY-DOWN-EVENT (:KEY KEY)  
      (WHEN (SDL:KEY= KEY :SDL-KEY-ESCAPE)  
        (SDL:PUSH-QUIT-EVENT)))  
  (:VIDEO-EXPOSE-EVENT () (SDL:UPDATE-DISPLAY)))))) 
}}}

If `:POLL`, `WITH-EVENTS` will continuously poll for pending events. If no events are available then the game loop is run and the forms in :IDLE are executed. 

If `:WAIT`, `WITH-EVENTS` will sleep indefinitely for the next available event. If no events are available then the game loop is paused. `:IDLE` is ignored when the event mechanism is `:WAIT`. 

== Events ==

The following events are supported;

  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Active_Event Active/Focus Mouse and Keyboard], 
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Keyboard_Events Key Down/up],
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Mouse_Motion_Event Mouse Motion],
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Mouse_Button_Events Mouse Button Down/Up], 
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Joystick_Motion_Event Joystick Axis Motion], 
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Joystick_Button_Events Joystick Button Down/Up], 
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Joystick_Hat_Motion_Event Joystick Hat], 
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Joystick_Ball_Motion_Event Joystick Ball], 
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Window_Resize_Event Display Resized], 
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Window_Expose_Event Display Exposed],
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Window_Manager_Events Window Manager Events], 
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Quit_Event Quit Events], 
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#User_Events User Defined Events],
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#IDLE_Event Idle Events]

=== Idle Event ===

{{{
 (:IDLE ()  
    &BODY BODY) 
}}}

The `:IDLE` event is special in that it is not a system generated event. The forms in `:IDLE` are executed once per game loop after all events in the event queue are processed. `:IDLE` is ignored when the event mechanism is `:WAIT`. 

=== Active Event ===

{{{
(:ACTIVE-EVENT (:GAIN GAIN :STATE STATE)  
   &BODY BODY)
}}}

`:ACTIVE-EVENT` is generated when the application gains or loses mouse, key or active state. For example an `:ACTIVE-EVENT` event is received when the mouse is moved outside the boundary of the application window.

The following functions return the current state of the application, or interpret the value of `:STATE`.

  * `MOUSE-FOCUS-P` returns `T` if the application has mouse focus - the mouse is within the window area.
  * `INPUT-FOCUS-P` returns `T` if the application has the keyboard focus - keys are captured by the application.
  * `ACTIVE-P` returns `T` if the application is not minimized.

For example;

{{{
>> (SDL:MOUSE-FOCUS-P state)
T
}}}

The following functions return the event type, interpreting the value of `:GAIN` and `:STATE` to determine if the application has gained or lost mouse, key or active state.

  * `MOUSE-GAIN-FOCUS-P` if mouse focus was gained or lost, when the mouse leaves or enters the window area
  * `INPUT-GAIN-FOCUS-P` if input focus was gained or lost, the application loses or gains keyboard focus, usually when a different application is made active
  * `ACTIVE-GAIN-P` if the application was minimized/iconified, or restored. `:GAIN` is `T`, when restored and `NIL` minimized/iconified. A single event can have multiple values set in STATE.

For example;

{{{
>> (SDL:MOUSE-GAIN-FOCUS-P gain state)
T
}}}

Use :GAIN and :STATE in combination to determine the active event, for example;

{{{
(:ACTIVE-EVENT (:GAIN gain :STATE state)
   (WHEN (SDL:MOUSE-FOCUS-P state) ;; Mouse focus event
       (IF (SDL:MOUSE-GAIN-FOCUS-P gain state)
            ;; Mouse over window
            )))
}}}

If the application window has gained state, then `:GAIN` will be `1`, otherwise `:GAIN` will be `0` (zero).

`:STATE` contains a bitmask of any or all of `APP-MOUSE-FOCUS`, `APP-INPUT-FOCUS` or `APP-ACTIVE` identifying the events that caused the change in state.

Note: This event is *not* generated when an application window is first created. 

=== Keyboard Events ===

{{{
(:KEY-DOWN-EVENT (:STATE STATE :SCANCODE SCANCODE :KEY KEY :MOD MOD :MOD-KEY MOD-KEY :UNICODE UNICODE)
   &BODY BODY)
}}}
{{{
(:KEY-UP-EVENT (:STATE STATE :SCANCODE SCANCODE :KEY KEY :MOD MOD :MOD-KEY MOD-KEY :UNICODE UNICODE)
   &BODY BODY)
}}}

A keyboard event generally occurs when a key is released or when a key is pressed. 
The information on the key that generated the event is stored in `KEY` and `MOD`. 

The `SDL-CAPS-LOCK` and `SDL-NUM-LOCK` keys are special cases and report an 
`SDL-KEY-DOWN` when first pressed, then an `SDL-RELEASED` when released and pressed again.

The KEYUP and KEYDOWN events are therefore analogous to the state of
 the caps lock and num lock LEDs rather than the keys themselves. These special
 cases are required for compatibility with Sun workstations.

*Note:* Repeating `KEY-DOWN-EVENT` events will occur if key repeat is enabled using
[SDL-ENABLE-KEY-REPEAT](#sdl-enable-key-repeat).

  * `STATE` is `SDL-PRESSED` or `SDL-RELEASED` if the key is pressed or released respectively.
  * `SCANCODE` is the hardware-dependent scancode returned by the keyboard.
  * `KEY` is the value of the key that generated the event. The value for `KEY` generally takes the following format: `:SDL-KEY-0` to `:SDL-KEY-1` for numeric keys. `SDL-KEY-a` to `SDL-KEY-z` for alpha keys in the range a-z.Other keys are generally spelled out, for example `SDL-KEY-PAGEDOWN`, `SDL-KEY-F1` or `SDL-KEY-NUMLOCK` .
  * `MOD` is the keyboard modifier state returned as an `INTEGER`.
  * `MOD-KEY` is the current state of the keyboard modifiers as explained in SDL_GetModState. Returned as a `LIST` of one or more of `:SDL-KEY-MOD-LSHIFT, :SDL-KEY-MOD-RSHIFT, :SDL-KEY-MOD-LCTRL, :SDL-KEY-MOD-RCTRL, :SDL-KEY-MOD-LALT, :SDL-KEY-MOD-RALT, :SDL-KEY-MOD-LMETA, :SDL-KEY-MOD-RMETA, :SDL-KEY-MOD-NUM, :SDL-KEY-MOD-CAPS, :SDL-KEY-MOD-MODE or :SDL-KEY-MOD-RESERVED`.
  * `UNICODE` is the translated character. The unicode field is only used when UNICODE translation is enabled with SDL_EnableUNICODE. If unicode is non-zero then this is the UNICODE character corresponding to the keypress. If the high 9 bits of the character are 0, then this maps to the equivalent ASCII character.

=== Mouse Motion Event ===

{{{
(:MOUSE-MOTION-EVENT (:STATE STATE :X X :Y Y :X-REL X-REL :Y-REL Y-REL)  
   &BODY BODY) 
}}}

A `MOUSE-MOTION-EVENT` event occurs when the mouse moves within the application window or when `SDL-WARP-MOUSE` is called. Both the absolute `X` and `Y` and relative `X-REL` and `Y-REL` coordinates are reported along with the current button state `STATE`. The button state can be interpreted using `SDL-BUTTON`, see `SDL-GET-MOUSE-STATE`. 

If the cursor is hidden using `SDL-SHOW-CURSOR` and the input is grabbed using `SDL-WM-GRAB-INPUT`, then the mouse will give relative motion events even when the cursor reaches the edge of the screen. This is currently only implemented on Windows and Linux/Unix-alikes.
 
  * STATE is the current button state.
  * X is the X coordinates of the mouse
  * Y is the Y coordinates of the mouse
  * X-REL is the relative motion in the X direction
  * Y-REL is the relative motion in the Y direction

=== Mouse Button Events ===

{{{
 (:MOUSE-BUTTON-DOWN-EVENT (:BUTTON BUTTON :STATE STATE :X X :Y Y)  
   &BODY BODY)  
}}}
{{{
 (:MOUSE-BUTTON-UP-EVENT (:BUTTON BUTTON :STATE STATE :X X :Y Y)  
   &BODY BODY) 
}}}

When a mouse button press or release is detected the number of the button pressed (from 1 to 255, with 1 usually being the left button and 2 the right) is placed into BUTTON, the position of the mouse when this event occurred is stored in the X and the Y fields. 

Mouse wheel events are reported as buttons 4 (up) and 5 (down). Two events are generated i.e. a MOUSE-BUTTON-DOWN followed by a MOUSE-BUTTON-UP event. 

  * BUTTON is the mouse button index which is one of SDL-BUTTON-LEFT, SDL-BUTTON-MIDDLE, SDL-BUTTON-RIGHT, SDL-BUTTON-WHEELUP or SDL-BUTTON-WHEELDOWN. 
  * STATE is the state of the button which is SDL-PRESSED or SDL-RELEASED.
  * X is the X coordinates of the mouse at press/release time.
  * Y is the Y coordinates of the mouse at press/release time.

=== Joystick Motion Event ===

{{{
(:JOY-AXIS-MOTION-EVENT (:WHICH WHICH :AXIS AXIS :VALUE VALUE)  
   &BODY BODY) 
}}}

A JOY-AXIS-MOTION-EVENT event occurs whenever a user moves an axis on the joystick. 

  * WHICH is the joystick device index. The index of the joystick that reported the event.
  * AXIS is the joystick axis index
  * VALUE is the current position of the axis (range: -32768 to 32767)

=== Joystick Button Events ===

{{{
(:JOY-BUTTON-DOWN-EVENT (:WHICH WHICH :BUTTON BUTTON :STATE STATE)  
   &BODY BODY)  
}}}
{{{
(:JOY-BUTTON-UP-EVENT (:WHICH WHICH :BUTTON BUTTON :STATE STATE)  
   &BODY BODY) 
}}}

A JOY-BUTTON-DOWN-EVENT or JOY-BUTTON-DOWN-EVENT event occurs whenever a user presses or releases a button on a joystick. 

  * WHICH is the index of the joystick that reported the event.
  * BUTTON is the button pressed that caused the event.
  * STATE is the current state of the button and is either SDL-PRESSED or SDL-RELEASED. 

=== Joystick Hat Motion Event ===

{{{
   (:JOY-HAT-MOTION-EVENT (:WHICH WHICH :HAT HAT :VALUE VALUE)  
     &BODY BODY) 
}}}

A JOY-HAT-MOTION-EVENT event occurs when ever a user moves a hat on the joystick. 

  * WHICH is the index of the joystick that reported the event.
  * HAT is the index of the hat that generated the event.
  * VALUE is the current position of the hat, a bitwise OR'd combination of the following values SDL-HAT-CENTERED, SDL-HAT-UP, SDL-HAT-RIGHT, SDL-HAT-DOWN, SDL-HAT-LEFT, SDL-HAT-RIGHT-UP, SDL-HAT-RIGHT-DOWN, SDL-HAT-LEFT-UP and SDL-HAT-LEFT-DOWN. 

=== Joystick Ball Motion Event ===

{{{
(:JOY-BALL-MOTION-EVENT (:WHICH WHICH :BALL BALL :X-REL X-REL :Y-REL Y-REL)  
  &BODY BODY) 
}}}

A JOY-BALL-MOTION-EVENT event occurs when a user moves a trackball on the joystick. Trackballs only return relative motion. 

  * WHICH is the index of the joystick that reported the event.
  * BALL is the index of the trackball that generated the event.
  * X-REL is the change in X position of the ball since it was last polled (last cycle of the event loop). 
  * Y-REL is the change in Y position of the ball since it was last polled (last cycle of the event loop). 

=== Quit Event ===

{{{
(:QUIT-EVENT ()  
   &BODY BODY) 
}}}

If `:QUIT-EVENT` is filtered or ignored then it is impossible for the user to close the window. If `:QUIT-EVENT` is handled and returns `T` then the application window will be closed. If `:QUIT-EVENT` is handled and returns `NIL` then the application window will not be closed. [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#quit-requested QUIT-REQUESTED] will return non-zero if a `:QUIT-EVENT` is pending. 

Note: Screen updates will continue to report success even though the application is no longer visible. 

=== Window Resize Event ===

{{{
(:VIDEO-RESIZE-EVENT (:W W :H H)  
   ...) 
}}}

When `SDL-RESIZABLE` is passed as a flag to WINDOW, the user is allowed to resize the application window. When the window is resized a `VIDEO-RESIZE-EVENT` event is reported, with the new window width and height values stored in `W` and `H` respectively. When an `VIDEO-RESIZE-EVENT` event is received the window should be resized to the new dimensions using WINDOW. 

=== Video Expose Event ===

{{{
(:VIDEO-EXPOSE-EVENT ()  
   ...) 
}}}

A `VIDEO-EXPOSE-EVENT` is generated when the screen has been modified outside of the application, usually by the window manager, and needs to be redrawn. For example the window may be 'Maximized' or 'Restored'.

_Note:_ A `VIDEO-EXPOSE_EVENT` is not generated when the window or screen is initially displayed.

=== Window Manager Events ===

{{{
(:SYS-WM-EVENT ()  
   ...) 
}}}

The system window manager event contains a pointer to system-specific information about unknown window manager events. If this event is enabled using SDL-EVENT-STATE, it will be generated whenever unhandled events are received from the window manager. This can be used, for example, to implement cut-and-paste in your application. If you want to obtain system-specific information about the window manager, you can fill in the version member of a SDL-SYS-WM-INFO structure using SDL-VERSION, and pass it to the function: SDL-GET-WM-INFO 

=== User Events ===

{{{
(:USER-EVENT (:TYPE TYPE :CODE CODE :DATA1 DATA1 :DATA2 DATA2)  
   ...) 
}}}

USER-EVENT is unique in that it is created by the user. USER-EVENT can be pushed onto the event queue using PUSH-USER-EVENT. The contents of the event are completely up to the programmer. 

  * TYPE is a value from SDL-USER-EVENT to (- SDL-NUM-EVENTS 1)` inclusive.
  * CODE is a user defined event code
  * DATA1 is a user defined data pointer
  * DATA2 is a user defined data pointer

=== Syntax of WITH-EVENTS ===

{{{
(WITH-EVENTS (TYPE)  
 (:ACTIVE-EVENT (:GAIN GAIN :STATE STATE)  
    ... )  
 (:KEY-DOWN-EVENT (:STATE STATE :SCANCODE SCANCODE :KEY KEY :MOD MOD :UNICODE UNICODE)  
    ... )  
 (:KEY-UP-EVENT (:STATE STATE :SCANCODE SCANCODE :KEY KEY :MOD MOD :UNICODE UNICODE)  
    ...)  
 (:MOUSE-MOTION-EVENT (:STATE STATE :X X :Y Y :X-REL X-REL :Y-REL Y-REL)  
    ...)  
 (:MOUSE-BUTTON-DOWN-EVENT (:BUTTON BUTTON :STATE STATE :X X :Y Y)  
    ...)  
 (:MOUSE-BUTTON-UP-EVENT (:BUTTON BUTTON :STATE STATE :X X :Y Y)  
    ...)  
 (:JOY-AXIS-MOTION-EVENT (:WHICH WHICH :AXIS AXIS :VALUE VALUE)  
    ...)  
 (:JOY-BUTTON-DOWN-EVENT (:WHICH WHICH :BUTTON BUTTON :STATE STATE)  
    ...)  
 (:JOY-BUTTON-UP-EVENT (:WHICH WHICH :BUTTON BUTTON :STATE STATE)  
    ...)  
 (:JOY-HAT-MOTION-EVENT (:WHICH WHICH :HAT HAT :VALUE VALUE)  
    ...)  
 (:JOY-BALL-MOTION-EVENT (:WHICH WHICH :BALL BALL :X-REL X-REL :Y-REL Y-REL)  
    ...)  
 (:VIDEO-RESIZE-EVENT (:W W :H H)  
    ...)  
 (:VIDEO-EXPOSE-EVENT ()  
    ...)  
 (:SYS-WM-EVENT ()  
    ...)  
 (:USER-EVENT (:TYPE TYPE :CODE CODE :DATA1 DATA1 :DATA2 DATA2)  
    ...)  
 (:QUIT-EVENT ()  
    ...  
    T)  
 (:IDLE ()  
    ... )) 
}}}

= Input State =
== Querying the Keyboard State ==

  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#key-held-p KEY-HELD-P], returns the duration in seconds that the key has been depressed over a number of game loops.
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#key-pressed-p KEY-PRESSED-P], returns `T` if the key has just been depressed in the current game loop.
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#key-released-p KEY-RELEASED-P], returns `T` if the key has just been released in the current game loop.
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#key-time-in-current-state KEY-TIME-IN-CURRENT-STATE], returns the duration in seconds that key is either pressed or depressed.
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#key-time-in-previous-state KEY-TIME-IN-PREVIOUS-STATE], returns the duration in seconds that key was in its previous state, either pressed or depressed.

  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#key-down-p KEY-DOWN-P], returns `T` if the key is depressed.
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#keys-down-p KEYS-DOWN-P], returns a list of the keys that are depressed.
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#mod-down-p MOD-DOWN-P], returns `T` if the modifier key is depressed.
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#mods-down-p MODS-DOWN-P], returns a list of the modifier keys that are depressed.
  
== Querying the Mouse State ==

  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#mouse-held-p MOUSE-HELD-P], returns the duration in seconds that the mouse button has been depressed over a number of game loops.
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#mouse-pressed-p MOUSE-PRESSED-P], returns `T` if the mouse button has just been depressed in the current game loop.
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#mouse-released-p MOUSE-RELEASED-P], returns `T` if the mouse button has just been released in the current game loop.
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#mouse-time-in-current-state MOUSE-TIME-IN-CURRENT-STATE], returns the duration in seconds that mouse button has been either pressed or depressed.
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#mouse-time-in-previous-state MOUSE-TIME-IN-PREVIOUS-STATE], returns the duration in seconds that mouse button was in its previous state, either pressed or depressed.

  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#mouse-x MOUSE-X], returns the absolute mouse `X` cursor position.
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#mouse-y MOUSE-Y], returns the absolute mouse `Y` cursor position.
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#mouse-position MOUSE-POSITION], returns the absolute mouse `X` and `Y` cursor positions as a `VECTOR`.
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#mouse-relative-position MOUSE-RELATIVE-POSITION], returns the relative mouse `X` and `Y` cursor positions as a `VECTOR`. This is the delta between the current mouse position and the position when `MOUSE-RELATIVE-POSITION` was last called.
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#mouse-buttons MOUSE-BUTTONS], returns a list of the depressed mouse buttons.
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#mouse-left-p MOUSE-LEFT-P], returns `T` if the left mouse button is depressed.
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#mouse-middle-p MOUSE-MIDDLE-P], returns `T` if the middle mouse button is depressed.
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#mouse-right-p MOUSE-RIGHT-P], returns `T` if the right mouse button is depressed.
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#mouse-wheel-up-p MOUSE-WHEEL-UP-P], returns `T` if the mouse wheel is rotated up.
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#mouse-wheel-down-p MOUSE-WHEEL-DOWN-P], returns `T` if the mouse wheel is rotated down.
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#mouse-x1-p MOUSE-X1-P], returns `T` if the extended mouse button `X1` is depressed.
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#mouse-x2-p MOUSE-X2-P], returns `T` if the extended mouse button `X2` is depressed.

== Querying the Joystick State ==
[TBD]

= Frame Rate and Timestep =
== Introduction to Frame Rate and Timestep ==

Simple games can get away with locking the physics simulation to the frame rate. For games that require an accurate physics simulation, the physics simulation must be decoupled from the display frame rate. These two modes are supported by the game loop.

The logic for each mode is encapsulated within a frame rate manager;

  * `FPS-FIXED`, supports a constant or unlocked frame rate where the physics simulation is locked to the frame rate,
  * `FPS-UNLOCKED`, supports an unlocked frame rate where the physics simulation is decoupled from the frame rate, but uses a callback to update the physics simulation.
  * `FPS-TIMESTEP`, same as `FPS-UNLOCKED`, but uses `WITH-TIMESTEP` to update the physics simulation. 

The functions used to query and manage frame rate are as follows;

  * `SYSTEM-TICKS`, returns the number of ticks (milliseconds) since system boot,
  * `FRAME-RATE`, query or set the target frame rate. Useful only for `FPS-FIXED` and ignored otherwise,
  * `DT`, returns current time step for the frame and should be used to update the physics simulation,
  * `AVERAGE-FPS`, returns the average frames per second,

Use [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#frame-rate FRAME-RATE] to set the frame rate. For example to set the frame rate to 60 frames per second;

{{{
(SETF (SDL:FRAME-RATE) 60)
}}}

To unlock the frame rate, effectively running the game loop as fast as the CPU will allow, set the `FRAME-RATE` to `NIL`; 

{{{
(SETF (SDL:FRAME-RATE) NIL)
}}}

The delta between frames is retrieved using [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#dt DT]

{{{
(SDL:DT)
}}}

The maximum `dt` is retrieved using [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#max-dt MAX-DT].

{{{
(SDL:MAX-DT)
}}}


== Constant Frame Rate ==

The game loop may be executed a fixed number of frames per second or as fast as possible. Games that implement a simple physics simulation can get away with locking the physics simulation to to the frame rate and updating the physics simulation once per game loop. 
In this mode the value of `DT` will change due to small variations in the duration of each frame. The algorithm used to maintain the frame rate is the same as described in [http://www.ferzkopp.net/joomla/content/view/19/14/ SDL_gfx].

`:IDLE` is executes each frame and contains game logic, physics and sprite and screen redraws.

The constant frame rate manager, `FPS-FIXED`, must be initialized at display creation time, prior to entering the game loop

{{{
(SDL:WINDOW 320 240 :FPS (make-instance 'sdl:fps-fixed))
}}}

`FPS-FIXED` accepts the following optional keyword arguments;

  * `:TARGET-FRAME-RATE` attempts to maintain the specified frame rate,
  * `:WORLD` is used in the calculation of `DT`, where `dt = (/ (- current-frame-ticks previous-frame-ticks) world)`,
  * `:WINDOW` is the number of previous frames over which the average frame rate is calculated,
  * `:MAX-DELTA` is the maximum number of milliseconds between frames.

== Constant Time-step ==

Games that implement a complex physics simulation must use a constant timestep. To maintain a constant timestep the physics simulation is be decoupled from the frame rate. The algorithm used is the same as is described in [http://www.gaffer.org/game-physics/fix-your-timestep/ Fix Your Timestep!]. 

The physics simulation can be updated via a callback using `FPS-UNLOCKED`, and within `WITH-TIMESTEP` using `FPS-TIMESTEP`.

=== Physics Inline ===

`FPS-TIMESTEP` must be initialized prior to entering the game loop, at display creation time.

{{{
(SDL:WINDOW 320 240 :FPS (make-instance 'sdl:fps-timestep))
}}}

`FPS-TIMESTEP` accepts the following optional keyword parameters;

  * `:WORLD` is used in the calculation of `DT`, where `dt = (/ (- current-frame-ticks previous-frame-ticks) world)`,
  * `:WINDOW` is the number of previous frames over which the average frame rate is calculated,
  * `:MAX-DT` is the maximum number of milliseconds that the physics simulation can run during a single frame.
  * `:DT` is the timestep (in milliseconds) that is used to update the physics simulation.

Use `:IDLE` to redraw the screen each frame. To update the physics simulation use [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-timestep WITH-TIMESTEP]. `WITH-TIMESTEP` will update the physics simulation as is necessary per frame. This means that the forms within `WITH-TIMESTEP` are executed more often per frame on machines having a lower frame rate.

{{{
;; Idle work
(:idle
 ;; Clear screen
 (sdl:clear-display sdl:*black*)

 (sdl:with-timestep ()
   ;; Update the particles
   (dolist (p *particles*)
     (update-particle p (/ (sdl::dt) 1000))))

 ;; Update the particles
 (dolist (p *particles*)
   (sdl:draw-surface-at-* *particle-img*
                          (round (vec2-x (particle-pos p)))
                          (round (vec2-y (particle-pos p)))))
 ;; Flip back/front buffers
 (sdl:update-display))
}}}

=== Physics Callback ===

`FPS-UNLOCKED` uses a callback mechanism to update the physics simulation. The callback is passed to `FPS-UNLOCKED` as an optional keyword parameter;

  * `:PS-FN` is the callback function used to update the physics simulation. This callback must be specified as follows.

{{{
#'(lambda (ticks dt)
    ...)
}}}

For example;

{{{
(defun physics (ticks dt)
  (declare (ignore ticks))
  (dolist (p *particles*)
    (update-particle p (/ dt 1000))))

(SDL:WINDOW 320 240 :FPS (make-instance 'sdl:fps-unlocked :ps-fn #'physics))
}}}

= Default Keyword Arguments =

Many of the functions and macros defined in lispbuilder accept one or more keyword arguments. For example the function [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-pixel DRAW-PIXEL] accepts `:COLOR` and `:SURFACE` keyword arguments that are bound to the symbols [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*default-color* *DEFAULT-COLOR*] and [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*default-surface* *DEFAULT-SURFACE*] respectively. The objects that are bound to these symbols will be used unless the keyword arguments are overridden by the developer. 

The macros [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-surface WITH-SURFACE], and [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-surfaces WITH-SURFACES] will bind a surface to [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*DEFAULT-SURFACE* *DEFAULT-SURFACE*] within the scope of these macros. For example, instead of specifying a target surface for each `draw-*` function a user may bind [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*DEFAULT-SURFACE* *DEFAULT-SURFACE*] to a surface once and subsequent `draw-*` functions will use this surface while it remains in scope.

{{{
(DRAW-PIXEL (point :x x1 :y y1) :surface a-surface :color *white*)
(DRAW-PIXEL (point :x x2 :y y2) :surface a-surface :color *white*)	    
(DRAW-PIXEL (point :x x3 :y y3) :surface a-surface :color *white*)
(DRAW-PIXEL (point :x x4 :y y4) :surface a-surface :color *white*)
}}}

Now, we use [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-surface WITH-SURFACE] to bind a surface to [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*DEFAULT-SURFACE* *DEFAULT-SURFACE*].

{{{
(WITH-SURFACE (a-surface)
  (DRAW-PIXEL (point :x x1 :y y1) :color *white*)
  (DRAW-PIXEL (point :x x2 :y y2) :color *white*)
  (DRAW-PIXEL (point :x x3 :y y3) :color *white*)
  (DRAW-PIXEL (point :x x4 :y y4) :color *white*))
}}}

We can use [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-color WITH-COLOR] to bind [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*DEFAULT-COLOR* *DEFAULT-COLOR*] to [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*white* *WHITE*]:

{{{
(WITH-SURFACE (a-surface)
  (WITH-COLOR (*white*)
    (DRAW-PIXEL (point :x x1 :y y1))
    (DRAW-PIXEL (point :x x2 :y y2))
    (DRAW-PIXEL (point :x x3 :y y3))
    (DRAW-PIXEL (point :x x4 :y y4)))
}}}

Finally, if the target surface is the display then [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#WITH-SURFACE *WITH-SURFACE*] is not required as `:SURFACE` when `NIL` will be bound to [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*DEFAULT-DISPLAY* *DEFAULT-DISPLAY*] as a convenience. So the above code can be shortened as follows:

{{{
(WITH-COLOR (*white*)
  (DRAW-PIXEL (point :x x1 :y y1))
  (DRAW-PIXEL (point :x x2 :y y2))
  (DRAW-PIXEL (point :x x3 :y y3))
  (DRAW-PIXEL (point :x x4 :y y4)))
}}}

But default keyword arguments have an added advantage other than keystroke savings. The macro [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-color WITH-COLOR] does not bind a color to the global symbol [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*default-color* *DEFAULT-COLOR*] but rather creates a new local variable called [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*default-color* *DEFAULT-COLOR*]. The local variable in effect _shadows_ the global symbol. Thus [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*default-color* *DEFAULT-COLOR*] is bound to the color black ONLY within the scope of [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-color WITH-COLOR]. This means we are able to nest several [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-color WITH-COLOR] macros creating in effect a stack. We push a new color onto the stack with each subsequent [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-color WITH-COLOR] and the system pops a color from the stack when a [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-color WITH-COLOR] goes out of scope. This is illustrated by the following example:

{{{
(with-surface (*default-display*)
  (with-color (#(0 0 0))
    (with-color (#(255 255 255))
      (draw-rectangle #(10 10 200 200)))
    (draw-rectangle #(40 40 200 100))))
}}}

This code performs the following hand-waving:

 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-surface WITH-SURFACE] binds the global symbol [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*default-surface* *DEFAULT-SURFACE*] to the display surface (stored in [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*default-display* *DEFAULT-DISPLAY*]).
 * Each call to [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-color WITH-COLOR] creates a new *local* variable [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*default-color* *DEFAULT-COLOR*] and binds this to the specified color. This local variable [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*default-color* *DEFAULT-COLOR*] is valid only within the scope of [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-color WITH-COLOR].  Each new [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*default-color* *DEFAULT-COLOR*] in effect 'shadows' the previous [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*default-color* *DEFAULT-COLOR*].
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-rectangle DRAW-RECTANGLE] takes as keyword arguments `:COLOR` and `:SURFACE`, where `:COLOR` is bound to the local [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*default-color* *DEFAULT-COLOR*] and `:SURFACE` is bound to [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*default-surface* *DEFAULT-SURFACE*].

And thanks to the wonders of Lisp indentation we are able to visualize the color stack directly in the code making debugging a lot easier. 

= Optional Packages =

The LISPBUILDER-SDL core functionality can be extended by using one or more of the following packages;

  * *lispbuilder-sdl-gfx*: 2D graphical effects such as zooming, rotation, circles, polygons and squares, using [http://www.ferzkopp.net/Software/SDL_gfx-2.0/ SDL_gfx]
  * *lispbuilder-sdl-image*: Support for multiple image formats such as PNG and JPG, using [http://www.libsdl.org/projects/SDL_image/ SDL_image]
  * *lispbuilder-sdl-mixer*: Sound mixing, using [http://www.libsdl.org/projects/SDL_mixer/ SDL_mixer] a multi-channel audio mixer library
  * *lispbuilder-sdl-ttf*: True-type font rendering, using [http://www.libsdl.org/projects/SDL_ttf/ SDL_ttf]
  * *lispbuilder-sdl-net*: Networking, using [http://www.libsdl.org/projects/SDL_net/ SDL_net] a cross-platform, blocking network library.

== LISPBUILDER-SDL-GFX ==

=== Overview ===

`LISPBUILDER-SDL-GFX` provides support for the rendering of several graphics primitives directly to SDL surfaces via a native library. 

Functions and symbols exported from the LISPBUILDER-SDL-GFX package are accessible using the LISPBUILDER-SDL-GFX: prefix or the shorter form SDL-GFX: nickname. 

=== Loading LISPBUILDER-SDL-GFX ===

After [http://code.google.com/p/lispbuilder/wiki/DownloadInstallation#lispbuilder-sdl-gfx installation] is complete, `LISPBUILDER-SDL-GFX` can be loaded by entering the following at the `REPL`;

{{{
(ASDF:OPERATE 'ASDF:LOAD-OP :LISPBUILDER-SDL-GFX)
}}}

=== Loading LISPBUILDER-SDL-GFX Examples ===

Enter the following at the REPL to load the examples in the `LISPBUILDER-SDL-GFX-EXAMPLES package`;

{{{
(asdf:operate 'asdf:load-op :lispbuilder-sdl-gfx-examples)
}}}
	

The following examples are contained in the package `LISPBUILDER-SDL-GFX-EXAMPLES`: 

{{{
(SDL-GFX-EXAMPLES:RECURSION)
(SDL-GFX-EXAMPLES:METABALLS)
(SDL-GFX-EXAMPLES:POINTS-AND-LINES)
(SDL-GFX-EXAMPLES:FUNCTIONS)
(SDL-GFX-EXAMPLES:WIDTH-HEIGHT)
(SDL-GFX-EXAMPLES:INBUILT-FONT)
(SDL-GFX-EXAMPLES:BEZIER)
(SDL-GFX-EXAMPLES:VERTICES)
(SDL-GFX-EXAMPLES:SHAPE-PRIMITIVES)
(SDL-GFX-EXAMPLES:SETUP-AND-DRAW)
(SDL-GFX-EXAMPLES:DISTANCE-2D)
(SDL-GFX-EXAMPLES:RANDOM-CIRCLES)
(SDL-GFX-EXAMPLES:OBJECTS)
}}}

=== Using LISPBUILDER-SDL-GFX ===

The `LISPBUILDER-SDL-GFX` APIs have the same signature as the `LISPBUILDER-SDL` versions. See the [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#contents LISPBUILDER-SDL API Reference] for the APIs supported by `LISPBUILDER-SDL-GFX`.


== LISPBUILDER-SDL-IMAGE ==

=== Overview ===

`LISPBUILDER-SDL-IMAGE` supports the following image formats: TGA, BMP, PNM, PBM, PGM, PPM, XPM, XCF, PCX , GIF, JPG, TIF, LBM and PNG

`LISPBUILDER-SDL-IMAGE` will attempt to detect the image type and load an image using the Magic Number in the image file. For image formats that have no magic number such as targa (.TGA), [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#load-image LOAD-IMAGE] allows the image type to be specified as a parameter. 

Functions and symbols exported from the LISPBUILDER-SDL-IMAGE package are accessible using the LISPBUILDER-SDL-IMAGE: prefix or the shorter form SDL-IMAGE: nickname. 

=== Loading LISPBUILDER-SDL-IMAGE ===

After [http://code.google.com/p/lispbuilder/wiki/DownloadInstallation#lispbuilder-sdl-image installation] is complete, `LISPBUILDER-SDL-IMAGE` can be loaded by entering the following at the `REPL`;

{{{
(ASDF:OPERATE 'ASDF:LOAD-OP :LISPBUILDER-SDL-IMAGE)
}}}

=== Loading LISPBUILDER-SDL-IMAGE Examples ===

Enter the following at the REPL to load the examples in the `LISPBUILDER-SDL-IMAGE-EXAMPLES package`;

{{{
(asdf:operate 'asdf:load-op :lispbuilder-sdl-image-examples)
}}}
	

The following examples are contained in the package `LISPBUILDER-SDL-IMAGE-EXAMPLES`: 

{{{
(SDL-IMAGE-EXAMPLES:IMAGE-EXAMPLE)
}}}

=== Using LISPBUILDER-SDL-IMAGE ===

The `LISPBUILDER-SDL-IMAGE` APIs have the same signature as the `LISPBUILDER-SDL` versions. 

 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#load-image LOAD-IMAGE]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#image-p IMAGE-P]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#image-type-of IMAGE-TYPE-OF]

_Note_ that external libraries must be installed for JPG, PNG and TIFF support: 

 * JPG support requires the JPEG library:
    ** http://www.ijg.org/
 * PNG support requires the PNG library, and the ZLib library:
    ** http://www.libpng.org/pub/png/libpng.html, and 
    ** http://www.gzip.org/zlib/
 * TIFF support requires the TIFF library:
    ** ftp://ftp.sgi.com/graphics/tiff/

== LISPBUILDER-SDL-TTF ==

=== Overview ===

`LISPBUILDER-SDL-TTF` provides support for the loading and rendering of True-Type fonts. 

Functions and symbols exported from the LISPBUILDER-SDL-TTF package are accessible using the `LISPBUILDER-SDL-TTF:` prefix or the shorter form `SDL-TTF:` nickname. 

The TrueType library is automatically initialized and uninitialized by the `LISPBUILDER-SDL` package. The functions [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#init-ttf INIT-TTF] and [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#quit-ttf QUIT-TTF] are added to the lists [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*external-init-on-startup* *EXTERNAL-INIT-ON-STARTUP*] and [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*external-quit-on-exit* *EXTERNAL-QUIT-ON-EXIT*]. `LISPBUILDER-SDL` iterates over these lists in calls to [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#init-sdl INIT-SDL], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#quit-sdl QUIT-SDL] and [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-init WITH-INIT] in order to initialize or uninitialize any external libraries such as `LISPBUILDER-SDL-TTF`.

=== Loading LISPBUILDER-SDL-TTF ===

After [http://code.google.com/p/lispbuilder/wiki/DownloadInstallation#lispbuilder-sdl-ttf installation] is complete, `LISPBUILDER-SDL-TTF` can be loaded by entering the following at the `REPL`;

{{{
(ASDF:OPERATE 'ASDF:LOAD-OP :LISPBUILDER-SDL-TTF)
}}}

=== Loading LISPBUILDER-SDL-TTF Examples ===

Enter the following at the REPL to load the examples in the `LISPBUILDER-SDL-TTF-EXAMPLES package`;

{{{
(asdf:operate 'asdf:load-op :lispbuilder-sdl-ttf-examples)
}}}
	

The following examples are contained in the package `LISPBUILDER-SDL-TTF-EXAMPLES`: 

{{{
(SDL-TTF-EXAMPLES:FONT-EXAMPLE)
}}}

=== Using LISPBUILDER-SDL-TTF ===

The `LISPBUILDER-SDL-TTF` APIs have the same signature as the `LISPBUILDER-TTF` versions. See the [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#contents LISPBUILDER-SDL API Reference] for the APIs supported by `LISPBUILDER-SDL-TTF`.




= Primitives =

LISPBUILDER-SDL supports [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#rectangle RECTANGLE] and [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#color COLOR] primitives. These are described below.

== Rectangle ==

A new rectangle is created by the function [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#rectangle RECTANGLE]. The function [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#rectangle-from-edges RECTANGLE-FROM-EDGES] will create a new rectangle from the specified top left and bottom right coordinates. The function [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#rectangle-from-midpoint-* RECTANGLE-FROM-MIDPOINT-*] will create a new rectangle from midpoint.

The macros [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-rectangle WITH-RECTANGLE] and [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-rectangle WITH-RECTANGLE]s will create a new rectangle and free this rectangle when it goes out of scope. 

The rectangle position and width and height can be inspected and modified using the following functions: [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#x X], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#y Y], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#width WIDTH] and [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#height HEIGHT]. [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#x2 X2] and [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#y2 Y2] will return the `(+ x width)` and `(+ y height)` of the rectangle respectively.

Additional functions that operate on rectangles are as follows:

 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#set-point-* POINT-*]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#get-point GET-POINT]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#set-point SET-POINT]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#position POSITION]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#get-position GET-POSITION]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#rectangle-* RECTANGLE-*] 
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#get-rectangle GET-RECTANGLE]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#set-rectangle SET-RECTANGLE]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-box DRAW-BOX]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-rectangle DRAW-RECTANGLE]

== Color ==

Use [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#color COLOR] to create a new `RGB` or `RGBA` color. 

`RGB/A` color componets can be manipulated using the functions [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#r R], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#g G], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#b B], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#a A], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#set-color SET-COLOR] and [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#set-color-* SET-COLOR-*]. Compare colors using [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#color= COLOR=].

Functions that accept a color parameter will most likely bind color to [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*default-color* *DEFAULT-COLOR*] if unspecified. The macro [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-color WITH-COLOR] will bind a color to [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*default-color* *DEFAULT-COLOR*] within the scope of this macro. When [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*default-color* *DEFAULT-COLOR*] is bound to a color, all subsequent drawing functions will use this implied color while it remains in scope.

Additional functions that operate on colors are as follows:

 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#color-* COLOR-*]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#any-color-but-this ANY-COLOR-BUT-THIS]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#map-color MAP-COLOR]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#pack-color PACK-COLOR]

LISPBULDER-SDL also contains several predefined colors; 

 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*black* *BLACK*]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*white* *WHITE*]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*red* *RED*]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*green* *GREEN*]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*blue* *BLUE*]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*yellow* *YELLOW*]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*cyan* *CYAN*]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*magenta* *MAGENTA*]

= Drawing =

LISPBUILDER-SDL provides low-level drawing support for several primitives. Most primitives can be drawn with or without alpha transparency. In addition, the filled primitives can be drawn with a single pixel outline (or stroke) that is a different color to the fill color.

 * Blitting Surfaces: [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-surface DRAW-SURFACE] and [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#blit-surface BLIT-SURFACE]
 * Bezier and Cutmull-Rom Curves: [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-bezier DRAW-BEZIER], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-shape DRAW-SHAPE], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-bezier WITH-BEZIER], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-curve WITH-CURVE] and [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-curve DRAW-CURVE].
 * Boxes and Rectangles: [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-box DRAW-BOX], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-rectangle DRAW-RECTANGLE].
 * Circles: [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-circle DRAW-CIRCLE] and [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-filled-circle DRAW-FILLED-CIRCLE].
 * Lines: [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-hline DRAW-HLINE], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-vline DRAW-VLINE] and [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-line DRAW-LINE].
 * Points: [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-pixel DRAW-PIXEL].
 * Polygons and Triangles: [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-polygon DRAW-POLYGON], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-trigon DRAW-TRIGON] and [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-shape WITH-SHAPE].
 * Filling Surfaces with Color: [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#fill-surface FILL-SURFACE]
 * Filling Arbitrary Shapes with Color: [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#flood-fill FLOOD-FILL]

= Displaying Text =

`LISPBUILDER-SDL` can render text over a transparent background (Solid rendering), render text over a colored background (Shaded rendering), and anti-alias text into a transparent background (blended text). Text may be left, right or center justified. Text can be rendered using bitmaps fonts or Truetype fonts.

The following table described the text capabilities of `LISPBUILDER-SDL`;

|| *Package* || *"Simple" Fonts* || *Bitmap Fonts* || *Truetype Fonts* || 
|| `LISPBUILDER-SDL` || Yes || Yes || Using `VECTO` ||
|| `VECTO` || NO || No || Yes ||
|| `LISPBUILDER-SDL-GFX` || No || Yes || No ||
|| `LISPBUILDER-SDL-TTF || No || No || Yes ||


== Fonts ==

Initializing fonts;

  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Font_Initialization INITIALISE-FONT] initializes a font for use from the specified font definition. 
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Font_Initialization INITIALISE-DEFAULT-FONT] initializes a font for use from the specified font definition. Uses the `*font-8x8*` font definition if unspecified. 

Setting the font typeface;

  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Font_Style SET-FONT-STYLE] sets the font Typeface of normal, bold, italic or underline. 

Drawing text to a surface;

  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Rendering_Text DRAW-STRING-SOLID] draw text with a transparent background
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Rendering_Text DRAW-STRING-SOLID-*]
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Rendering_Text DRAW-STRING-SHADED] draw text with a colored background
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Rendering_Text DRAW-STRING-SHADED]
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Rendering_Text DRAW-STRING-BLENDED] draw anti-aliased text with a transparent background
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Rendering_Text DRAW-STRING-BLENDED-*]

Draw text to a new surface;

  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Rendering_Text RENDER-STRING-SOLID] returns a new surface containing the text and having a transparent background sized to the text width and height
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Rendering_Text RENDER-STRING-SHADED] returns a new surface containing the text having a colored background sized to the text width and height
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Rendering_Text RENDER-STRING-BLENDED] returns a new surface containing the anti-aliased text having a transparent background sized to the text width and height

Blit a cached surface to the target surface;

  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Rendering_Text DRAW-FONT] blits the cached `SURFACE` in the font to the destination `SURFACE`. The cached surface is created during a previous call to any of the `RENDER-STRING*` functions.
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Rendering_Text DRAW-FONT-AT]
  * [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Rendering_Text DRAW-FONT-AT-*]

Querying font attributes;

  * `X`, `Y`, `WIDTH`, `HEIGHT` return the position and dimensions of the cached font surface
  * `get-Glyph-Metric`
  * `get-Font-Size`
  * `set-Font-style`
  * `get-Font-style`
  * `get-font-height`
  * `get-font-ascent`
  * `get-font-descent`
  * `get-font-line-skip`
  * `get-font-faces`
  * `get-font-face-family-name`
  * `get-font-face-style-name`
  * `font-fixed-width-p`
  * `CHAR-WIDTH`
  * `CHAR-HEIGHT`
  * `CHAR-PITCH`
  * `CHAR-SIZE`

Freeing a font;

  * `free-cached-surface`
  * `FREE`

Font macros;

  * `WITH-DEFAULT-FONT`
  * `WITH-FONT`

=== Bitmapped Fonts ===

`LISPBUILDER-SDL` supports two kinds of bitmap fonts; a "simple" font where the font data is created from a bitmapped image loaded from the drive, and a bitmap font having the font data used in `SDL_gfx`. 

The "simple" font is available using the `*simple-font-4x5*` font definition. The font looks as follows;

http://lispbuilder.googlecode.com/svn/trunk/documentation/font.jpg

Bitmaps fonts support the SDL_gfx font format. The following bitmap font definitions are created at compile time and are always accessible in the `LISPBUILDER-SDL` library; `*FONT-10X20*`, `*FONT-5X7*`, `*FONT-5X8*`, `*FONT-6X10*`, `*FONT-6X12*`, `*FONT-6X13*`, `*FONT-6X13B*`, `*FONT-6X13O*`, `*FONT-6X9*`, `*FONT-7X13*`, `*FONT-7X13B*`, `*FONT-7X13O*`, `*FONT-7X14*`, `*FONT-7X14B*`, `*FONT-8X13*`, `*FONT-8X13B*`, `*FONT-8X13O*`, `*FONT-8X8*`, `*FONT-9X15*`, `*FONT-9X15B*`, `*FONT-9X18*` and `*FONT-9X18B*`.

=== Truetype Fonts ===

Support for Truetype fonts is provided by [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#LISPBUILDER-SDL-TTF LISPBUILDER-SDL-TTF] or [http://www.xach.com/lisp/vecto/ VECTO].

The [http://www.xach.com/lisp/vecto/#sect-text VECTO] documentation describes how to render text using this package. Once rendered, text is copied from a VECTO buffer into a `LISPBUILDER-SDL` `SURFACE` using `VECTO->SURFACE`.

== Font Attributes ===

=== Glyph Metrics ===

{{{
}}}

`GET-GLYPH-METRIC` returns the glyph metrics for the character `CH`, or `NIL` upon error. 

  * `CH` is a Unicode character specified as an `INTEGER`.
  * `FONT` is the `FONT` object from which to retrieve the glyph metrics of the character `CH`. Binds to `*DEFAULT-FONT*` by default.
  * `METRIC` is a `KEY`word argument and may be one of; `:MINX` for the minimum `X` offset, `:MAXX` for the maximum `X` offset, `:MINY` for the minimum `Y` offset, `:MAXY` for the maximum `Y` offset, `:ADVANCE` for the advance offset. 

For example;

{{{
(SDL:GET-GLYPH-METRIC char :METRIC :MINX
}}}

=== Font Size ===

{{{
}}}

`GET-FONT-SIZE` calculates and returns the resulting `SIZE` of the `SURFACE` that is required to render the `TEXT`, or `NIL` on error. No actual rendering is performed, however correct kerning is calculated for the actual width. The height returned is the same as returned using `GET-FONT-HEIGHT`. 

  * `TEXT` is the string to size, of type `STRING`. 
  * `SIZE` must be one of; `:W` for the text width or `:H` for the text height.
  * `FONT` is the font used to calculate the size of the `TEXT`. Binds to `*DEFAULT-FONT*` by default.

=== Font Style ===

{{{
}}}

`GET-FONT-STYLE` returns the rendering style of the `FONT`. If no style is set then `:STYLE-NORMAL` is returned, or `NIL` upon error.
  
  * `FONT` is a `FONT` object. Binds to `*DEFAULT-FONT*` by default. 
  * Returns the font style as one or more of: `:STYLE-NORMAL`, `:STYLE-BOLD`, `:STYLE-ITALIC`, `:STYLE-UNDERLINE`

`SET-FONT-STYLE` sets the rendering `STYLE` of `FONT`. This will flush the internal cache of previously rendered glyphs, even if there is no change in style, so it may be best to check the current style using `GET-FONT-STYLE` before setting the style. 

  * `STYLE` is a list of one or more: `:STYLE-NORMAL`, `:STYLE-BOLD`, `:STYLE-ITALIC`, `:STYLE-UNDERLINE`. 

_Node_: Combining `:STYLE-UNDERLINE` with anything can cause a *segfault*, other combinations may also do this.

=== Font Height ===

{{{
}}}

`GET-FONT-HEIGHT` returns the maximum pixel height of all glyphs of `FONT`. 
Use this height for rendering text as close together vertically as possible, 
though adding at least one pixel height to it will space it so they can't touch. 
Remember that `LISPBUILDER-SDL` doesn't handle multi-line printing so you are responsible 
for line spacing, see `GET-FONT-LINE-SKIP` as well. 

  * `FONT` is a `FONT` object. Binds to `*DEFAULT-FONT*` by default. 
  * Returns the height of the `FONT` as an `INTEGER`.

=== Font Ascent ===

{{{
}}}

`GET-FONT-ASCENT` returns the maximum pixel ascent of all glyphs of `FONT`. 
This can also be interpreted as the distance from the top of the font to the baseline. 
It could be used when drawing an individual glyph relative to a top point, by combining it with the glyph's `:MAXY` metric to resolve the top of the rectangle used when blitting the glyph on the screen. 

  * `FONT` is a `FONT` object. Binds to `*DEFAULT-FONT*` by default.
  * Returns the ascent of the `FONT` as an `INTEGER`.

=== Font Descent ===

{{{
}}}

`GET-FONT-DESCENT` returns the maximum pixel descent of all glyphs of `FONT`. 
This can also be interpreted as the distance from the baseline to the bottom of the font. 
It could be used when drawing an individual glyph relative to a bottom point, by combining it with the glyph's `:MAXY` metric to resolve the top of the rectangle used when blitting the glyph on the screen. 

  * `FONT` is a `FONT` object. Binds to `*DEFAULT-FONT*` by default.
  * Returns the descent of the `FONT` as an `INTEGER`.

=== Font Line Skip ===

{{{
}}}

`GET-FONT-LINE-SKIP` returns the recommended pixel height of a rendered line of text of the `FONT`. This is usually larger than the `GET-FONT-HEIGHT` of the font. 

  * `FONT` is a `FONT` object. Binds to `*DEFAULT-FONT*` by default.
  * Returns the pixel height of the `FONT` as an `INTEGER`.

=== Font Faces ===

{{{
}}}

`GET-FONT-FACES` returns the number of faces 'sub-fonts' available in the `FONT`. 
This is a count of the number of specific fonts (based on size and style and other typographical features perhaps) contained in the font itself. It seems to be a useless
 fact to know, since it cannot be applied in any other font functions.

  * `FONT` is a `FONT` object. Binds to `*DEFAULT-FONT*` by default.
  * Returns the number of faces in the `FONT` as an `INTEGER`.

=== Font Fixed Width ===

{{{
}}}

'FONT-FIXED-WIDTH-P` returns `T` if the font face is of a fixed width, or `NIL` otherwise. Fixed width fonts are mono-space, meaning every character that exists in the font is the same width. 

  * `FONT` is a `FONT` object. Binds to `*DEFAULT-FONT*` by default.
  * Returns `T` if `FONT` is of fixed width, and `NIL` otherwise.

=== Font Face Family Name ===

{{{
}}}

`GET-FONT-FACE-FAMILY-NAME` returns the current font face family name of `FONT` or `NIL` if the information is unavailable. 

  * `FONT` is a `FONT` object. Binds to `*DEFAULT-FONT*` by default.
  * Returns the name of the `FONT` face family name as a `STRING`, or `NIL` if unavailable.

=== Font Face Style Name ===

{{{
}}}

`GET-FONT-FACE-STYLE-NAME` returns the current font face style name of `FONT`, or `NIL` if the information is unavailable. 

  * `FONT` is a `FONT` object. Binds to `*DEFAULT-FONT*` by default.
  * Returns the name of the `FONT` face style as a `STRING`, or `NIL` if unavailable.

=== Free Cached Surface ===

{{{
}}}

`FREE-CACHED-SURFACE` will free the `FONT` cached surface created in a `RENDER-STRING` call.

=== Free Font ===

{{{
}}}

`FREE` will all resources allocated for the `FONT` including any cached surface.

== Font Initialization ==

A font must be initialized prior to use using [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#initialise-default-font INITIALISE-DEFAULT-FONT], or [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#initialise-font INITIALISE-FONT]. These functions accept a [http://code.google.com/p/lispbuilder/wiki/UsingLispbuilderSDL#Font_Definition font definition] and return a font object or `NIL` if the font cannot be initialized. [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#initialise-default-font INITIALISE-DEFAULT-FONT] will use `*font-8x8*` if a definition is unspecified. [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#initialise-default-font INITIALISE-DEFAULT-FONT] binds the new font to `*DEFAULT-FONT*` to be used for subsequent font rendering or drawing operations.

{{{
initialise-font font-definition => result
}}}

Resources allocated to a font are freed by [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#free FREE]. 

== Font Definition ==

[http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#initialise-default-font INITIALISE-DEFAULT-FONT] and [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#initialise-font INITIALISE-FONT] accept a font definition and return a font object. A font definition is specific to the type of font.

To load a Truetype font from disk, first create a Truetype font definition as follows;

{{{
(make-instance 'SDL:ttf-font-definition
               :size 32
               :filename (merge-pathnames "Vera.ttf" *default-font-path*))
}}}

Then pass this font definition to [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#initialise-default-font INITIALISE-DEFAULT-FONT], or [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#initialise-font INITIALISE-FONT] to create the font object.

{{{
(defparameter *vera-ttf* (make-instance 'SDL:ttf-font-definition
                                        :size 32
                                        :filename (merge-pathnames "Vera.ttf" *default-font-path*))

(unless (SDL:INITIALIZE-DEFAULT-FONT *vera-ttf*)
   (error "Cannot create font."))
}}}

To create a bitmap font definition, where `:DATA` is the same format of the fonts used in `SDL_gfx`;

{{{
(make-instance 'SDL:bitmap-font-definition
               :width 6
               :height 9
               :data #(...)))
}}}

To create a simple font definition;

{{{
(make-instance 'SDL:simple-font-definition
               :width 4 :height 5
               :character-map "abcdefghijklmnopqrstuvwxyz:'!?_-,.()#~0123456789"
               :color-key (sdl:color :r 99 :g 0 :b 0)
               :filename (create-path "font.bmp" *default-asset-path*)
               :pad-x 0 :pad-y 0)
}}}

== Rendering Text ==

LISPBUILDER-SDL supports the rendering of colored text over a transparent background (Solid rendering), and the rendering of colored text over a solid colored background (Shaded rendering). Text may be left, right or center justified. Text is drawn to a target surface using the `DRAW-STRING` functions, or rendered to a new surface of character height and string width using the `RENDER-STRING` functions. the `RENDER-STRING` functions can optionally cache the new surface in the font object. A cached surface can be accessed using [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#cached-surface CACHED-SURFACE]) and can be blitted to a target surface using [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-font DRAW-FONT].

The following functions draw text directly to a surface;

  * `draw-string-solid`
  * `draw-string-solid-*`
  * `draw-string-shaded`
  * `draw-string-shaded-*`
  * `draw-string-blended`
  * `draw-string-blended-*`

The following functions will draw text to a new surface, and optionally cache that surface in the `FONT` object;

  * `render-string-solid`
  * `render-string-shaded`
  * `render-string-blended`
  * `CACHED-SURFACE`

The following functions will blit the cached surface to the target surface;

  * `DRAW-FONT-AT`
  * `DRAW-FONT-AT-*`

The following methods also apply to fonts; [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#x X], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#y Y], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#width WIDTH], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#height HEIGHT], returns the width of the cached [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#surface SURFACE].

The font rendering functions accept a font object which is bound to [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*default-font* *DEFAULT-FONT*] when unspecified. The function [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#initialise-default-font INITIALISE-DEFAULT-FONT] and the macros [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-font WITH-FONT] and [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-default-font WITH-DEFAULT-FONT] will bind a font to [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*default-font* *DEFAULT-FONT*]. All font drawing or font rendering functions that take a &KEYword or &OPTIONAL `:FONT` argument will use the font assigned to [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*default-font* *DEFAULT-FONT*] unless another font is specified. This makes calling these functions a bit easier as the `:FONT` parameter need not be explicitly passed. For example: 

{{{
(WITH-COLOR (*WHITE*)
  (WITH-FONT (*FONT-8x8*)
    (DRAW-STRING-SOLID-* "Font is 8x8." 10 10)

    (WITH-FONT (*FONT-10x20*)
      (DRAW-STRING-SOLID-* "Font is 10x20." 10 20))

    (DRAW-STRING-SOLID-* "Font is 8x8 again." 10 40)))
}}}

Note the difference between [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-font WITH-FONT] and [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-default-font WITH-DEFAULT-FONT].

  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-font WITH-FONT] takes a font definition and will initialize and assign the font to `*DEFAULT-FONT` within the scope of the macro. The font will be closed when out of scope of the macro. 
  * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-default-font WITH-DEFAULT-FONT] takes an already initialized font object and assigns the font to `*DEFAULT-FONT` within the scope of the macro. 

=== Rendering Solid Text ===

{{{
draw-string-solid string p1 &key justify surface font color => result
draw-string-solid-* string x y &key justify surface font color => result
}}}

Renders the `STRING` using `FONT` with text `COLOR` to the target `SURFACE`. The surface background is transparent and therefore can be keyed over other surfaces.

Use `:CACHE T` to cache the new surface in the `FONT` object.
When `:FREE T` any existing cached surface in `FONT` is automatically freed.
When `:FREE NIL` the caller is responsible for freeing any existing cached surface in `FONT`.

Any cached surface can be accessed using `CACHED-SURFACE` and can be blitted to a target surface using `DRAW-FONT`.

For example;

{{{
(SDL:DRAW-STRING-SOLID "Hello World!" :COLOR SDL:*WHITE*)
}}}

Renders the `STRING` using `FONT` with text `COLOR` to a new `SURFACE`. The surface background is transparent and therefore can be keyed over other surfaces. The dimensions of the new surface are `FONT` height and width x `STRING` length. The surface background is transparent and can be keyed over other surfaces.

{{{
render-string-solid string &key font color free cache => result
}}}

=== Shaded ===

{{{
draw-string-shaded string p1 fg-color bg-color &key justify surface font => result
draw-string-shaded-* string x y fg-color bg-color &key justify surface font => result
}}}

Draw `STRING` using `FONT` with foreground color `FG-COLOR` and background color `BG-COLOR` to the target `SURFACE`.  `FONT` is bound to `*DEFAULT-FONT*` if unspecified. 

Use `:CACHE T` to cache the new surface in the `FONT` object.
When `:FREE T` any existing cached surface in `FONT` is automatically freed.

For example;

{{{
(SDL:DRAW-STRING-SHADED "Hello World!" SDL:*WHITE* SDL:*BLUE*)
}}}


{{{
render-string-shaded string fg-color bg-color &key font free cache => result
}}}

Draw `STRING` using `FONT` with foreground color `FG-COLOR` and background color `BG-COLOR` to a new `SURFACE`.  `FONT` is bound to `*DEFAULT-FONT*` if unspecified. The dimensions of the new surface are `FONT` height and width x `STRING` length. The surface background is transparent and can be keyed over other surfaces.

=== Blended ===

{{{
draw-string-blended string p1 &key justify surface font color => result
draw-string-blended-* string x y &key justify surface font color => result
}}}

Draw the anti-aliased `STRING` using `FONT` with text `COLOR` to the target `SURFACE`.  `FONT` is bound to `*DEFAULT-FONT*` if unspecified. The surface background is transparent and can be keyed over other surfaces.

Use `:CACHE T` to cache the new surface in the `FONT` object.
When `:FREE T` any existing cached surface in `FONT` is automatically freed.
When `:FREE NIL` the caller is responsible for freeing any existing cached surface in `FONT`.

Any cached surface can be accessed using `CACHED-SURFACE` and can be blitted to a target surface using `DRAW-FONT`.

For example;

{{{
(SDL:DRAW-STRING-BLENDED "Hello World!" :COLOR SDL:*WHITE*)
}}}

Draw the anti-aliased `STRING` using `FONT` with text `COLOR` to the target `SURFACE`. The dimensions of the new surface are `FONT` height and width x `STRING` length. The surface background is transparent and can be keyed over other surfaces.


= Surfaces =

== Overview of Surfaces ==

An SDL surface, [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#surface SURFACE], represents an area of _graphical_ memory that can be drawn or rendered to, for example the video framebuffer or an image that is loaded from disk.

== Creating Surfaces ==

A surface is created:

 * Automatically by the SDL library to represent a framebuffer by calling [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#window WINDOW].
 * When loading an image from disk using [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#load-image LOAD-IMAGE].
 * Explicitely using [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#create-surface CREATE-SURFACE], or [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#copy-surface COPY-SURFACE].
 * Implicitely using [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#convert-surface CONVERT-SURFACE].

Functions that accept a surface parameter will most likely bind surface to [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*default-surface* *DEFAULT-SURFACE*] when unspecified. The macros [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-surface WITH-SURFACE] and [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#with-surfaces WITH-SURFACES] will bind a [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*default-surface* *DEFAULT-SURFACE*] within the scope of these macro. [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*default-surface* *DEFAULT-SURFACE*] is bound to a surface, all subsequent drawing functions will use this implied surface while it remains in scope.

A surface can be explicitely freed by calling [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#free-surface FREE-SURFACE].

== Video Memory Or System Memory ==

A surface in system memory (software surface) improves the performance of pixel level access but is incompatible with some types of hardware blitting.

A surface in video memory (hardware surface) takes advantage of Video-to-Video blits which are often hardware accelerated.

A hardware surface (`SDL-HW-SURFACE`) must be locked prior to performing per-pixel manipulations. When locked the hardware surface is copied from video memory to system memory and copied back when unlocked. This can cause a *major* performance hit.

Use software surfaces (`SDL-SW-SURFACE`) to perform per-pixel manipulations, or to blit surfaces having alpha channels at a high frame rate when alpha blitting is not supported in hardware.

Use hardware surfaces when per-pixel manipulations are not required, or when the graphics hardware supports blitting of surfaces having alpha channels, or when the surfaces can be stored in video memory.

Many of the drawing functions require per-pixel manipulation of the destination surface. If drawing directly to the display surface then the display surface must be a software surface (in system memory) or performance will be effected.
Drawing functions that require per-pixel manipulation of a destination surface include; [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-bezier DRAW-BEZIER], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-curve DRAW-CURVE], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-shape DRAW-SHAPE], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-line DRAW-LINE], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-pixel DRAW-PIXEL], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#read-pixel READ-PIXEL], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-filled-circle, DRAW-FILLED-CIRCLE], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-circle, DRAW-CIRCLE], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-filled-circle, DRAW-FILLED-CIRCLE], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-trigon, DRAW-TRIGON], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-polygon, DRAW-POLYGON], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-ellipse, DRAW-ELLIPSE], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-filled-ellipse, DRAW-FILLED-ELLIPSE], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-pie, DRAW-PIE], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-filled-pie, DRAW-FILLED-PIE], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-filled-trigon, DRAW-FILLED-TRIGON], and [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-filled-polygon, DRAW-FILLED-POLYGON].

To efficiently use the drawing functions with hardware surfaces, render to a software surface and then blit the software surface to a hardware surface using [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#blit-surface BLIT-SURFACE].

== Images ==

BMP images are loaded from disk using [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#load-image LOAD-IMAGE]. Support for additional image formats is provided in `LISPBUILDER-SDL-IMAGE`. A surface is saved to disk as a BMP image using [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#save-image SAVE-IMAGE]

{{{
(DRAW-SURFACE (LOAD-IMAGE "sdl.bmp") 
              :surface *default-display*)
}}}

== Positioning Surfaces ==

A [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#surface SURFACE] stores its own position X/Y coordinates. These coordinates can be inspected and modified using the following functions: [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#x X], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#y Y], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#width WIDTH] and [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#height HEIGHT]. 

Additional functions and macros that manage surface coordinates are as follows: 

 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#point-* POINT-*]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#get-point GET-POINT]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#set-point SET-POINT]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#set-point-* SET-POINT-*]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#position-* POSITION-*]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#get-position GET-POSITION]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#set-position-* GET-POSITION]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#set-surface SET-SURFACE]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#set-surface-* SET-SURFACE-*]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#rectangle-* RECTANGLE-*]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#get-rectangle-* GET-RECTANGLE-*]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#get-surface-rect GET-SURFACE-RECT]
 * [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-surface-at DRAW-SURFACE-AT]

== Drawing & Blitting Surfaces ==
The functions [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#blit-surface BLIT-SURFACE] and [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-surface DRAW-SURFACE] will blit or draw a source surface onto a destination surface using the position coordinates stored in the source surface.[http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#draw-surface-at DRAW-SURFACE-AT] will draw the source surface at a specified position.

The composition rules that determine how the source surface is composed over the destination surface are described in the description of [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#blit-surface BLIT-SURFACE]. [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#fill-surface FILL-SURFACE] fill will the target surface with a single color. 
	  <a href="#devprim">Drawing Primitives</a> describes how [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#*default-surface* *DEFAULT-SURFACE*] is used when calling blitting operations.

Use [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#set-color-key SET-COLOR-KEY], [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#clear-color-key CLEAR-COLOR-KEY] and [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#set-alpha SET-ALPHA] to modify the key color and alpha transparency properties of a surface after the surface has been created.

Set a _clipping_ rectangle to limit the draw area on a destination surface. The clipping rectangle for a surface is manipulated using [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#get-clip-rect GET-CLIP-RECT] and [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#set-clip-rect SET-CLIP-RECT]. When this surface is the destination of a blit, only the area within the <em>clip</em> rectangle will be drawn into.

Set a _cell_ rectangle to limit the surface area on the source surface. The cell rectangle for a surface is manipulated using [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#clear-cell CLEAR-CELL] and [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#set-cell SET-CELL]. When this surface is the source of a blit, only the areas within the <em>cell</em> rectangle will be used. The cell is useful when only a small area of the source surface needs to be blitted to the destination surface. For example a sequence of images composed into a single sprite sheet and only the current frame of animation is to be drawn to the display at any one time.

http://lispbuilder.googlecode.com/svn/trunk/lispbuilder-sdl/documentation/waddle.png

== Updating Surfaces and the Display ==

The functions [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#update-display UPDATE-DISPLAY] and [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#update-surface UPDATE-SURFACE] update the SDL display surface (or OpenGL context) and general SDL surfaces respectively.

= The Cursor =

The the current state of the cursor is returned using [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#query-cursor QUERY-CURSOR], and is set using [http://lispbuilder.googlecode.com/svn/trunk/documentation/lispbuilder-sdl.html#query-cursor SHOW-CURSOR].

= A Simple Example =

Putting this all together, we can write short example showing a white rectangle that follows the users mouse movements within an SDL Window. Exit the example by closing the window or pressing the Esc key on the keyboard.

{{{
(WITH-INIT ()               ; Initialise SDL and the Video subsystem
  (WINDOW 320 240)          ; Open a window, 320 x 240

  (SETF (FRAME-RATE) 30)    ; Lock the frame rate to 30 fps

  (WITH-EVENTS ()
    (:QUIT-EVENT () T)      ; Absolutely have to handle the :QUIT-EVENT,
                            ; or the application will not exit.
    (:KEY-DOWN-EVENT () 
      (WHEN (KEY-DOWN-P :SDL-KEY-ESCAPE) (PUSH-QUIT-EVENT)))

    (:MOUSE-MOTION-EVENT (:X mouse-x :Y mouse-y)
      (CLEAR-DISPLAY *black*)
      ;; Draw the box with center at the mouse x/y coordinates.
      (DRAW-BOX-* (- mouse-x (/ 50 2)) (- mouse-y (/ 50 2)) 50 50 :color *white*))

    (:IDLE ()
      (UPDATE-DISPLAY))))
}}}

= Object Lifecycles and Garbage Collection =

*TBD*	  	  

= Package Overview =

== Package Exports ==
Functions and symbols exported from the `LISPBUILDER-SDL` package are accessible using the `LISPBUILDER-SDL:` prefix or the shorter form `SDL:` nickname.

== Package Structure ==
The `cffi/` directory contains the raw CFFI bindings. These bindings may be automatically generated by [http://www.swig.org SWIG] or created by hand depending on the package. CFFI translation functions perform simple low-level conversions for example, converting Lisp strings to C strings and back (see [http://code.google.com/p/lispbuilder/source/browse/trunk/lispbuilder-sdl-image/cffi/translate.lisp `translate.lisp`] for example). 
All functions in `cffi/` accept and return foreign objects only.

The `base/` directory defines wrappers over the functions in `cffi/`. 
The functions in `base/` accept keyword arguments and accept `NIL` instead of `CFFI:NULL-POINTER` where appropriate. Generally functions in `base/` accept and return foreign objects. `base/` may perform some type checks `(IS-VALID-PTR SURFACE)` but this layer is meant to be lean. Someone who implements a graphics engine might use this layer instead of `sdl/` if speed is a concern. There are no fancy drawing primitives in this layer.

The `sdl/` directory defines the abstractions over `cffi/` and `base/`. Foreign objects are passed around `sdl/` neatly wrapped in CLOS objects, using [http://www.cliki.net/trivial-garbage `TRIVIAL-GARBAGE`] for automatic garbage collection (minimize foreign objects being left on the heap). There are no functions in `sdl/` that accept or return foreign objects (with the exception of the functions that create the CLOS wrapper objects). Functions in `sdl/` call down into `cffi/` and `base/` as appropriate. All `LISPBUILDER-SDL` symbols available in `SDL:` are exported from `sdl/`, with symbols imported into `sdl/` from `cffi/` and `base/` as appropriate (e.g. `WITH-EVENTS`). All drawing primitives are defined in this layer; circles, rectangles, lines, triangles, with-bezier etc. Functions in `sdl/` implement a lot of type checking.

An example of the difference between `base/` and `sdl/` is `WITH-RECTANGLE`. The `WITH-RECTANGLE` macro in base/ creates and destroys a foreign `SDL_Rect`. The `WITH-RECTANGLE` macro in `sdl/` will create and destroy a `RECTANGLE` object.


= Examples =

Enter the following at the REPL to compile and load the examples included in the `LISPBUILDER-SDL-EXAMPLES` package:

{{{
(asdf:operate 'asdf:load-op :lispbuilder-sdl-examples)
}}}

Run the examples by entering any of the following at the REPL:
{{{
	  (SDL-EXAMPLES:BEZIER)
	  (SDL-EXAMPLES:BMP-SAMPLE)
	  (SDL-EXAMPLES:CIRCLE-1)
	  (SDL-EXAMPLES:CIRCLE-2)
	  (SDL-EXAMPLES:CIRCLE-3)
	  (SDL-EXAMPLES:CIRCLE-4)
	  (SDL-EXAMPLES:CIRCLE-5)
	  (SDL-EXAMPLES:DISTANCE-2D)
	  (SDL-EXAMPLES:FLOOD-FILL)
	  (SDL-EXAMPLES:INBUILT-FONTS)
	  (SDL-EXAMPLES:LINE-DRAWING)
	  (SDL-EXAMPLES:MANDELBROT)
	  (SDL-EXAMPLES:METABALLS)
	  (SDL-EXAMPLES:MOUSE-2D)
	  (SDL-EXAMPLES:MOUSE-PAINTER)
	  (SDL-EXAMPLES:PIXELS-1)
	  (SDL-EXAMPLES:PIXELS-2)
	  (SDL-EXAMPLES:PIXELS-3)
	  (SDL-EXAMPLES:PIXELS-4)
	  (SDL-EXAMPLES:POINTS-AND-LINES)
	  (SDL-EXAMPLES:RANDOM-RECTS)
	  (SDL-EXAMPLES:RANDOM-BOX-1)
	  (SDL-EXAMPLES:RANDOM-BOX-2)
	  (SDL-EXAMPLES:RANDOM-BOX-3)
	  (SDL-EXAMPLES:RANDOM-BOX-4)
	  (SDL-EXAMPLES:RECURSIVE-RECTS)
	  (SDL-EXAMPLES:SETUP-AND-DRAW)
	  (SDL-EXAMPLES:SIMPLE-FONT-DEMO)
	  (SDL-EXAMPLES:STROKE)
	  (SDL-EXAMPLES:VERTICES)
	  (SDL-EXAMPLES:WIDTH-HEIGHT)
}}}

= Using OpenGL =

Example of using `LISPBUILDER-SDL` and [http://common-lisp.net/project/cl-opengl/ CL-OPENGL]

{{{
(asdf:operate 'asdf:load-op :cl-opengl)

(defun opengl-test-1 ()
  (sdl:with-init ()
    (sdl:window 250 250
                :flags sdl:sdl-opengl
                :title-caption "OpenGL Example"
                :icon-caption "OpenGL Example")
    (gl:clear-color 0 0 0 0)
    ;; Initialize viewing values.
    (gl:matrix-mode :projection)
    (gl:load-identity)
    (gl:ortho 0 1 0 1 -1 1)
    (sdl:with-events ()
      (:quit-event () t)
      (:idle ()
       (gl:clear :color-buffer-bit)
       ;; Draw white polygon (rectangle) with corners at
       ;; (0.25, 0.25, 0.0) and (0.75, 0.75, 0.0).
       (gl:color 1 1 1)
       (gl:with-primitive :polygon
                          (gl:vertex 0.25 0.25 0)
                          (gl:vertex 0.75 0.25 0)
                          (gl:vertex 0.75 0.75 0)
                          (gl:vertex 0.25 0.75 0))
       ;; Start processing buffered OpenGL routines.
       (gl:flush)
       (sdl:update-display)))))
}}}

Use the following function to set the OpenGL attributes;

{{{
(SDL:SET-GL-ATTRIBUTE <attribute> <value>)
}}}

The following _attributes_ are supported;

  * :SDL-GL-RED-SIZE
  * :SDL-GL-GREEN-SIZE
  * :SDL-GL-BLUE-SIZE
  * :SDL-GL-ALPHA-SIZE
  * :SDL-GL-BUFFER-SIZE
  * :SDL-GL-DOUBLEBUFFER
  * :SDL-GL-DEPTH-SIZE
  * :SDL-GL-STENCIL-SIZE
  * :SDL-GL-ACCUM-RED-SIZE
  * :SDL-GL-ACCUM-GREEN-SIZE
  * :SDL-GL-ACCUM-BLUE-SIZE
  * :SDL-GL-ACCUM-ALPHA-SIZE
  * :SDL-GL-STEREO
  * :SDL-GL-MULTISAMPLEBUFFERS
  * :SDL-GL-MULTISAMPLESAMPLES
  * :SDL-GL-ACCELERATED-VISUAL
  * :SDL-GL-SWAP-CONTROL

The following function provides access to OpenGL. Use *after* an OpenGL context is created.

{{{
(setf cl-opengl-bindings:*gl-get-proc-address* #'sdl:sdl-gl-get-proc-address)
}}}

= Creating Standalone Executables =

Tutorials for creating standalone executables using the various Common Lisp development environments;

 * [StandAloneExecutables Creating standalone executables]
 * [StandAloneCLISP CLISP executable]